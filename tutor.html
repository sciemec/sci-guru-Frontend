<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sci-Guru AI Tutor</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- PDF export (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    .layout{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:14px;
      padding:18px 0 30px;
    }
    .chapters{
      position:sticky;
      top:76px;
      height: calc(100vh - 96px);
      overflow:auto;
      padding-right:6px;
    }
    .chapterBtn{
      width:100%;
      text-align:left;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      margin-bottom:10px;
      font-weight:700;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .chapterBtn small{
      display:block;
      color:var(--muted);
      font-weight:500;
      margin-top:4px;
    }
    .chapterBtn.active{
      border-color: rgba(47,107,255,.55);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12);
    }
    .check{
      font-size: 1rem;
      opacity: .85;
      margin-top:2px;
    }
    .mainArea{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin: 8px 0 12px;
    }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color: rgba(47,107,255,.55);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12);
    }

    .progressWrap{
      margin: 8px 0 14px;
      padding:12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }
    .mutedLine{ color: var(--muted); font-size: .92rem; line-height: 1.4; }

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .chapters{position:relative; top:auto; height:auto}
      .mainArea{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container row">
      <div class="brand">
        <img src="images/lec-logo.png" alt="LEC Biotec Logo">
        <div class="title">
          <b>Sci-Guru AI Science Tutor</b>
          <span>ZIMSEC / Heritage-Based curriculum</span>
        </div>
      </div>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a class="active" href="tutor.html">AI Tutor</a>
        <a href="library.html">My Library</a>
        <a href="virtual-lab-hub.html">Virtual Lab Hub</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="layout">

      <!-- LEFT: CHAPTERS -->
      <aside class="card chapters">
        <h2 style="margin-bottom:6px;">Chapters (1–17)</h2>
        <p class="small" style="margin-bottom:10px;">Progress is saved on your device.</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <span class="badge" id="apiStatus">API: checking...</span>
          <span class="badge">Render Free may sleep</span>
        </div>

        <div class="progressWrap">
          <div class="small" id="progressText">Progress: 0/17</div>
          <div class="bar" style="margin-top:8px;"><div id="barFill"></div></div>
        </div>

        <div id="chapterList"></div>

        <div style="margin-top:10px" class="small">
          Tip: When your book chapter titles are ready, I’ll replace these titles exactly.
        </div>
      </aside>

      <!-- RIGHT: ASK + OUTPUT -->
      <section class="mainArea">

        <!-- ASK -->
        <section class="card">
          <h2>Chapter Content</h2>
          <p class="small">Generate Notes / Worked Examples / Exam Questions / Marking Scheme.</p>

          <div class="pillRow" id="contentPills">
            <div class="pill active" data-mode="Notes">Notes</div>
            <div class="pill" data-mode="Worked Examples">Worked Examples</div>
            <div class="pill" data-mode="Past Exam Questions">Past Exam Questions</div>
            <div class="pill" data-mode="Marking Scheme">Marking Scheme</div>
          </div>

          <label class="small" for="form">Form / Level</label>
          <select id="form" class="input">
            <option value="Form 1">Form 1</option>
            <option value="Form 2">Form 2</option>
            <option value="Form 3">Form 3</option>
            <option value="Form 4">Form 4</option>
          </select>

          <div style="height:10px"></div>

          <label class="small" for="chapter">Selected Chapter</label>
          <input id="chapter" class="input" readonly />

          <div style="height:10px"></div>

          <label class="small" for="topic">Topic</label>
          <select id="topic" class="input"></select>

          <div style="height:10px"></div>

          <label class="small" for="q">Extra instruction (optional)</label>
          <textarea id="q" class="input" placeholder="e.g. Use Zimbabwe examples, make it short, include calculations, include safety notes..."></textarea>

          <div style="height:10px"></div>

          <div class="actions">
            <button class="btn primary" id="genBtn">Generate</button>
            <button class="btn" id="quizBtn">Quick Quiz</button>
            <button class="btn" id="pracBtn">Practical</button>
            <a class="btn" id="openLabBtn" href="virtual-lab-hub.html">Open related lab</a>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="toggleDoneBtn">Mark chapter as done</button>
            <a class="btn" href="library.html">Open My Library</a>
          </div>

          <div class="mutedLine" style="margin-top:12px;">
            Render free tier may sleep. First request can take longer.
          </div>
        </section>

        <!-- OUTPUT -->
        <section class="card">
          <h2>Output</h2>
          <p class="small">Generated content appears here. Save or export it.</p>

          <div id="out" class="card" style="background:rgba(255,255,255,.03); border-radius:12px; border:1px solid var(--border); box-shadow:none;">
            <p class="small" style="margin:0">No output yet.</p>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="saveBtn">Save to My Library</button>
            <button class="btn" id="pdfBtn">Download PDF</button>
            <button class="btn" id="copyBtn">Copy</button>
            <button class="btn" id="clearBtn">Clear</button>
          </div>

          <div class="small" style="margin-top:12px;">
            Tip: Save Notes + Worked Examples for revision, then generate Exam Questions to test yourself.
          </div>
        </section>

      </section>
    </div>
  </main>

  <script>
    const API_BASE = "https://sci-guru-backend.onrender.com";

    const STORAGE_PROGRESS = "sciguru_progress_v1";
    const STORAGE_SAVED = "sciguru_saved_v1";
    const STORAGE_LAST = "sciguru_last_v1";

    // Starter chapters (replace later with your exact book titles)
    const CHAPTERS = [
      { id: 1,  name: "Measurement & Safety", topics: ["Lab safety rules","SI units","Measuring length/mass/time","Accuracy & precision","Errors"] },
      { id: 2,  name: "States of Matter", topics: ["Solids, liquids, gases","Particle model","Changes of state","Diffusion","Brownian motion"] },
      { id: 3,  name: "Separating Mixtures", topics: ["Filtration","Evaporation","Distillation","Chromatography","Magnetism"] },
      { id: 4,  name: "Density", topics: ["Density concept","Mass & volume","Floating & sinking","Relative density","Practical density experiment"] },
      { id: 5,  name: "Heat & Temperature", topics: ["Heat vs temperature","Thermometers","Expansion","Conduction/Convection/Radiation","Cooling & insulation"] },
      { id: 6,  name: "Forces & Pressure", topics: ["Types of forces","Friction","Pressure in solids/liquids/gases","Upthrust","Applications of pressure"] },
      { id: 7,  name: "Work, Energy & Power", topics: ["Work done","Kinetic & potential energy","Energy conversions","Power","Efficiency"] },
      { id: 8,  name: "Electric Circuits (Basics)", topics: ["Electric current","Voltage & resistance","Series circuits","Parallel circuits","Cells & batteries","Safety with electricity"] },
      { id: 9,  name: "Magnetism & Electromagnets", topics: ["Magnetic materials","Magnetic fields","Electromagnets","Applications","Generators (intro)"] },
      { id: 10, name: "Waves & Sound", topics: ["Wave properties","Sound production","Pitch & loudness","Echoes","Hearing & safety"] },
      { id: 11, name: "Light", topics: ["Reflection","Refraction","Lenses","Images","Optical instruments"] },
      { id: 12, name: "Cells & Microscopy", topics: ["Cell structure","Microscope use","Plant vs animal cells","Specialised cells","Health link"] },
      { id: 13, name: "Reproduction (Basics)", topics: ["Human reproduction","Plant reproduction","Pollination","Fertilisation","Growth"] },
      { id: 14, name: "Ecology & Environment", topics: ["Food chains/webs","Habitat","Population","Pollution","Conservation in Zimbabwe"] },
      { id: 15, name: "Acids, Bases & Salts", topics: ["pH scale","Indicators","Neutralisation","Preparation of salts","Everyday examples"] },
      { id: 16, name: "Chemical Reactions", topics: ["Types of reactions","Word equations","Balancing (intro)","Rates of reaction","Catalysts"] },
      { id: 17, name: "Materials & Metals", topics: ["Properties of materials","Metals vs non-metals","Rusting","Alloys","Recycling"] }
    ];

    // Map chapter -> best lab page (edit filenames to match your repo)
    const LAB_LINKS = {
      "Separating Mixtures": "sim-mixtures.html",
      "Density": "sim-density.html",
      "Electric Circuits (Basics)": "sim-electricity.html"
    };

    // DOM
    const chapterListEl = document.getElementById("chapterList");
    const chapterEl = document.getElementById("chapter");
    const formEl = document.getElementById("form");
    const topicEl = document.getElementById("topic");
    const qEl = document.getElementById("q");
    const outEl = document.getElementById("out");
    const apiStatusEl = document.getElementById("apiStatus");
    const openLabBtn = document.getElementById("openLabBtn");
    const contentPills = document.getElementById("contentPills");
    const toggleDoneBtn = document.getElementById("toggleDoneBtn");
    const progressText = document.getElementById("progressText");
    const barFill = document.getElementById("barFill");

    let selectedChapter = CHAPTERS[0];
    let selectedMode = "Notes";
    let lastOutputText = "";
    let progress = loadProgress(); // { doneIds: [1,2,...] }

    function loadProgress(){
      try{
        const raw = localStorage.getItem(STORAGE_PROGRESS);
        const obj = raw ? JSON.parse(raw) : null;
        return obj && Array.isArray(obj.doneIds) ? obj : { doneIds: [] };
      }catch{
        return { doneIds: [] };
      }
    }
    function saveProgress(){
      localStorage.setItem(STORAGE_PROGRESS, JSON.stringify(progress));
    }
    function isDone(id){ return progress.doneIds.includes(id); }

    function updateProgressUI(){
      const done = progress.doneIds.length;
      const total = CHAPTERS.length;
      progressText.textContent = `Progress: ${done}/${total} chapters done`;
      const pct = total ? Math.round((done/total)*100) : 0;
      barFill.style.width = pct + "%";
      toggleDoneBtn.textContent = isDone(selectedChapter.id) ? "Mark chapter as NOT done" : "Mark chapter as done";
    }

    function renderOutput(text){
      lastOutputText = text || "";
      outEl.innerHTML = `<div style="white-space:pre-wrap; line-height:1.65">${text}</div>`;
    }

    function setMode(mode){
      selectedMode = mode;
      [...contentPills.querySelectorAll(".pill")].forEach(p=>{
        p.classList.toggle("active", p.dataset.mode === mode);
      });
    }

    function setChapter(ch){
      selectedChapter = ch;
      chapterEl.value = `Chapter ${ch.id}: ${ch.name}`;
      topicEl.innerHTML = ch.topics.map(t => `<option value="${t}">${t}</option>`).join("");

      const link = LAB_LINKS[ch.name] || "virtual-lab-hub.html";
      openLabBtn.href = link;

      [...chapterListEl.querySelectorAll(".chapterBtn")].forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.id == ch.id);
      });

      updateProgressUI();
      saveLastState();
    }

    function buildChapterButtons(){
      chapterListEl.innerHTML = "";
      CHAPTERS.forEach(ch=>{
        const btn = document.createElement("button");
        btn.className = "chapterBtn";
        btn.dataset.id = ch.id;

        const doneMark = isDone(ch.id) ? "✅" : "⬜";
        btn.innerHTML = `
          <div>
            Chapter ${ch.id}: ${ch.name}
            <small>${ch.topics.length} topics</small>
          </div>
          <div class="check">${doneMark}</div>
        `;

        btn.onclick = ()=> setChapter(ch);
        chapterListEl.appendChild(btn);
      });
    }

    function refreshChapterChecks(){
      [...chapterListEl.querySelectorAll(".chapterBtn")].forEach(btn=>{
        const id = Number(btn.dataset.id);
        const mark = btn.querySelector(".check");
        if(mark) mark.textContent = isDone(id) ? "✅" : "⬜";
      });
    }

    async function checkHealth(){
      try{
        const r = await fetch(`${API_BASE}/health`, { method:"GET" });
        if(!r.ok) throw new Error("Health not OK");
        apiStatusEl.textContent = "API: online";
      }catch(e){
        apiStatusEl.textContent = "API: offline / sleeping";
      }
    }

    async function callTutor(modeOverride){
      const mode = modeOverride || selectedMode;

      const payload = {
        mode,
        form: formEl.value,
        chapter: `Chapter ${selectedChapter.id}: ${selectedChapter.name}`,
        topic: topicEl.value || selectedChapter.name,
        question: qEl.value.trim() || "(no extra instruction)"
      };

      renderOutput("Loading... (Render may sleep on free tier)");
      try{
        const r = await fetch(`${API_BASE}/api/tutor`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.detail || data?.error || `Request failed (${r.status})`);

        renderOutput(data.text || "No text returned.");
        saveLastState();
      }catch(e){
        renderOutput("Error: " + e.message);
      }
    }

    function saveToLibrary(){
      const text = (outEl.innerText || "").trim();
      if(!text || text.toLowerCase().startsWith("loading") || text.toLowerCase().startsWith("error")){
        alert("Generate content first, then save.");
        return;
      }

      const item = {
        id: "sg_" + Date.now(),
        savedAt: new Date().toISOString(),
        mode: selectedMode,
        form: formEl.value,
        chapter: `Chapter ${selectedChapter.id}: ${selectedChapter.name}`,
        topic: topicEl.value || selectedChapter.name,
        instruction: qEl.value.trim(),
        content: text
      };

      const arr = loadLibrary();
      arr.unshift(item);
      localStorage.setItem(STORAGE_SAVED, JSON.stringify(arr));
      alert("Saved to My Library ✅");
    }

    function loadLibrary(){
      try{
        const raw = localStorage.getItem(STORAGE_SAVED);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }

    function downloadPDF(){
      const text = (outEl.innerText || "").trim();
      if(!text || text.toLowerCase().startsWith("loading") || text.toLowerCase().startsWith("error")){
        alert("Generate content first, then download PDF.");
        return;
      }

      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){
        alert("PDF library failed to load. Refresh page and try again.");
        return;
      }

      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const margin = 40;
      const maxWidth = 515;

      const title = `Sci-Guru - ${selectedMode}`;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text(title, margin, 55);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Form: ${formEl.value}`, margin, 75);
      doc.text(`Chapter: Chapter ${selectedChapter.id} - ${selectedChapter.name}`, margin, 90);
      doc.text(`Topic: ${topicEl.value || selectedChapter.name}`, margin, 105);

      const lines = doc.splitTextToSize(text, maxWidth);
      let y = 135;
      doc.setFontSize(11);

      lines.forEach(line=>{
        if(y > 800){
          doc.addPage();
          y = 50;
        }
        doc.text(line, margin, y);
        y += 14;
      });

      const safeName = `${selectedMode}_Chapter${selectedChapter.id}_${(topicEl.value||"Topic").replace(/[^a-z0-9]+/gi,"_")}.pdf`;
      doc.save(safeName);
    }

    function saveLastState(){
      const state = {
        mode: selectedMode,
        form: formEl.value,
        chapterId: selectedChapter.id,
        topic: topicEl.value || "",
        instruction: qEl.value || "",
        lastOutput: lastOutputText || ""
      };
      localStorage.setItem(STORAGE_LAST, JSON.stringify(state));
    }

    function restoreLastState(){
      try{
        const raw = localStorage.getItem(STORAGE_LAST);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.form) formEl.value = s.form;
        if(s.mode) setMode(s.mode);

        const ch = CHAPTERS.find(x => x.id === Number(s.chapterId)) || CHAPTERS[0];
        buildChapterButtons();
        setChapter(ch);

        if(s.topic){
          const options = [...topicEl.querySelectorAll("option")].map(o=>o.value);
          if(options.includes(s.topic)) topicEl.value = s.topic;
        }
        if(typeof s.instruction === "string") qEl.value = s.instruction;
        if(typeof s.lastOutput === "string" && s.lastOutput.trim()) renderOutput(s.lastOutput);
      }catch{
        // ignore
      }
    }

    // Events
    contentPills.addEventListener("click", (e)=>{
      const pill = e.target.closest(".pill");
      if(!pill) return;
      setMode(pill.dataset.mode);
      saveLastState();
    });

    document.getElementById("genBtn").onclick  = ()=> callTutor(selectedMode);
    document.getElementById("quizBtn").onclick = ()=> callTutor("Quiz");
    document.getElementById("pracBtn").onclick = ()=> callTutor("Practical");

    document.getElementById("saveBtn").onclick = saveToLibrary;
    document.getElementById("pdfBtn").onclick = downloadPDF;

    document.getElementById("copyBtn").onclick = async ()=>{
      const txt = (outEl.innerText || "").trim();
      if(!txt) return alert("Nothing to copy.");
      try{ await navigator.clipboard.writeText(txt); alert("Copied!"); }
      catch{ alert("Copy failed. Select and copy manually."); }
    };

    document.getElementById("clearBtn").onclick = ()=>{
      qEl.value = "";
      renderOutput("Cleared.");
      saveLastState();
    };

    toggleDoneBtn.onclick = ()=>{
      const id = selectedChapter.id;
      if(isDone(id)){
        progress.doneIds = progress.doneIds.filter(x => x !== id);
      }else{
        progress.doneIds.push(id);
      }
      saveProgress();
      updateProgressUI();
      refreshChapterChecks();
    };

    // Init
    buildChapterButtons();
    setChapter(CHAPTERS[0]);
    setMode("Notes");
    checkHealth();
    restoreLastState();
    updateProgressUI();
    refreshChapterChecks();
  </script>
</body>
</html>
