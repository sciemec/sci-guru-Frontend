<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sci-Guru • Form 1 Combined Science Tutor</title>
  <link rel="icon" href="lec-logo.jpg"/>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#081a3b;
      --card:rgba(255,255,255,.05);
      --stroke:rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --blue:#2f7bff;
      --purple:#7c5cff;
      --good:#33d07a;
      --warn:#ffcc66;
      --bad:#ff5a6b;
      --shadow: 0 18px 60px rgba(0,0,0,.25);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 20% 10%, rgba(47,123,255,.34), transparent 60%),
        radial-gradient(900px 520px at 90% 30%, rgba(124,92,255,.22), transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 14px 28px}

    /* Header */
    header{
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      padding:12px 14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:12px;overflow:hidden;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brandTitle{font-weight:900}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px}
    .topActions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      padding:10px 12px;border-radius:12px;
      font-weight:900;font-size:13px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{
      border-color:rgba(47,123,255,.55);
      background:linear-gradient(135deg, rgba(47,123,255,.95), rgba(124,92,255,.55));
      color:#071022;
    }

    /* Banner */
    .banner{
      margin-top:12px;
      padding:14px;
      border:1px solid var(--stroke);
      background:var(--card);
      border-radius: var(--radius);
    }
    .banner h1{margin:0;font-size:18px}
    .banner p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55}
    .hint{margin-top:8px;font-size:12px;color:rgba(234,242,255,.62)}

    /* Layout */
    .layout{
      margin-top:12px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:12px;
    }
    @media(max-width:980px){ .layout{grid-template-columns:1fr} }

    /* Sidebar */
    .sidebar{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .sidebarTitle{font-weight:900;margin:0 0 8px}
    .sidebarSub{font-size:12px;color:var(--muted);margin:0 0 10px}
    .topicBtn{
      width:100%;
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      color:rgba(234,242,255,.9);
      font-weight:900;
      cursor:pointer;
      margin-bottom:8px;
    }
    .topicBtn:hover{background:rgba(255,255,255,.06)}
    .topicBtn.active{
      border-color:rgba(47,123,255,.55);
      background:linear-gradient(135deg, rgba(47,123,255,.28), rgba(124,92,255,.18));
    }
    .topicTag{
      font-size:12px;
      color:rgba(234,242,255,.75);
      font-weight:800;
    }
    .miniRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      color:rgba(234,242,255,.85);
    }

    /* Main content split */
    .mainGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:980px){ .mainGrid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 8px;font-size:14px}
    .small{font-size:12px;color:var(--muted);line-height:1.5}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:10px 0}

    /* Labs list */
    .labItem{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:10px 12px;
      margin-top:10px;
    }
    .labName{font-weight:900}
    .openLink{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      padding:9px 10px;border-radius:12px;
      font-weight:900;font-size:13px;cursor:pointer;
      white-space:nowrap;
    }
    .openLink:hover{background:rgba(255,255,255,.08)}
    .statusOk{color:var(--good);font-weight:900}
    .statusBad{color:var(--bad);font-weight:900}

    /* Quiz */
    .quizBox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .qRow{margin:10px 0}
    select,input[type="text"]{
      width:100%;
      padding:10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .scoreBox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .bigScore{font-size:24px;font-weight:1000;margin-top:6px}
    .msgBox{
      margin-top:10px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:10px;
      background:rgba(0,0,0,.12);
      font-size:12px;line-height:1.55;
    }

    footer{
      margin-top:14px;
      text-align:center;
      color:rgba(234,242,255,.62);
      font-size:12px;
    }

    /* ===========================================================
       AI WIDGET CSS (scoped: DOES NOT touch your tutor layout)
       =========================================================== */
    #sg-ai-widget{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:18px;
      overflow:hidden;
      margin-top:10px;
    }
    #sg-ai-widget .sgw-head{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    #sg-ai-widget .sgw-title{display:flex;align-items:center;gap:10px;font-weight:900}
    #sg-ai-widget .sgw-dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--bad);
      box-shadow:0 0 12px rgba(255,90,107,.35);
    }
    #sg-ai-widget .sgw-dot.ok{
      background: var(--good);
      box-shadow:0 0 12px rgba(51,208,122,.35);
    }
    #sg-ai-widget .sgw-sub{font-size:12px;color:rgba(234,242,255,.72);font-weight:700;margin-top:2px}
    #sg-ai-widget .sgw-actions{display:flex;gap:8px;flex-wrap:wrap}
    #sg-ai-widget .sgw-btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;border-radius:12px;
      font-weight:900;font-size:12px;cursor:pointer;
    }
    #sg-ai-widget .sgw-btn:hover{background:rgba(255,255,255,.10)}
    #sg-ai-widget .sgw-body{padding:10px 12px;display:flex;flex-direction:column;gap:10px}
    #sg-ai-widget .sgw-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #sg-ai-widget .sgw-mini{flex:1;min-width:160px}
    #sg-ai-widget .sgw-chat{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      height:280px;overflow:auto;padding:10px;
    }
    #sg-ai-widget .sgw-msg{margin:0 0 10px;display:flex}
    #sg-ai-widget .sgw-msg.user{justify-content:flex-end}
    #sg-ai-widget .sgw-bubble{
      max-width:86%;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px 12px;
      font-size:13px;
      line-height:1.5;
      background:rgba(255,255,255,.06);
      white-space:pre-wrap;
    }
    #sg-ai-widget .sgw-msg.user .sgw-bubble{
      background:linear-gradient(135deg, rgba(47,123,255,.45), rgba(124,92,255,.28));
      border-color:rgba(47,123,255,.35);
    }
    #sg-ai-widget .sgw-compose{display:flex;gap:8px;align-items:center}
    #sg-ai-widget .sgw-send{
      border:1px solid rgba(47,123,255,.45);
      background:linear-gradient(135deg, rgba(47,123,255,.95), rgba(124,92,255,.55));
      color:#071022;
      padding:10px 12px;border-radius:12px;
      font-weight:1000;font-size:13px;cursor:pointer;
    }
    #sg-ai-widget .sgw-send:disabled{opacity:.55;cursor:not-allowed}
    #sg-ai-widget .sgw-hint{font-size:12px;color:rgba(234,242,255,.72)}
    #sg-ai-widget .sgw-chips{display:flex;gap:8px;flex-wrap:wrap}
    #sg-ai-widget .sgw-chip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:rgba(234,242,255,.85);
      padding:7px 10px;border-radius:999px;
      font-size:12px;font-weight:900;cursor:pointer;
    }
    #sg-ai-widget .sgw-chip:hover{background:rgba(255,255,255,.08)}
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand">
      <div class="logo">
        <img src="lec-logo.jpg" alt="logo"
             onerror="this.style.display='none';this.parentElement.textContent='SG';">
      </div>
      <div>
        <div class="brandTitle">Sci-Guru • Form 1 Combined Science Tutor</div>
        <div class="brandSub">ZIMSEC / Heritage-Based • Forms 1–4 (Form 1 content)</div>
      </div>
    </div>

    <div class="topActions">
      <a class="btn" href="index.html">Home</a>
      <a class="btn primary" href="labs-hub.html">Virtual Lab Hub</a>
    </div>
  </header>

  <section class="banner">
    <h1>Continue from your progress</h1>
    <p>
      Your scores and progress are saved on this device. If you see a 404, it usually means the
      filename in GitHub does not match the link (uppercase vs lowercase).
    </p>
    <div class="hint">Tip: Keep all filenames lowercase (example: <b>sim-cells-labels.html</b> not SIM-Cells-Labels.html)</div>
  </section>

  <section class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebarTitle">Form 1 Topics</div>
      <div class="sidebarSub">Click to jump</div>

      <div id="topicList"></div>

      <div class="miniRow">
        <span class="pill">Saved Progress ✓</span>
        <span class="pill" id="linkStatus">Links: checking…</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="mainGrid">

      <!-- Middle: Topic + Labs + Quiz -->
      <section class="card" id="topicCard">
        <h2 id="topicTitle">Topic</h2>
        <div class="small" id="topicDesc"></div>

        <div class="divider"></div>

        <h2>Virtual Experiment</h2>
        <div class="small">Open the correct lab for this topic.</div>

        <div id="labList"></div>

        <div class="divider"></div>

        <h2 id="quizTitle">Inline Quiz</h2>
        <div class="small" id="quizDesc">Click Start/Resume to load the quiz.</div>

        <div class="quizBox" id="quizBox">
          <div class="small" id="quizIntro">Click <b>Start / Resume</b> to load this topic quiz.</div>

          <div id="quizQuestions" style="display:none;"></div>

          <div class="rowBtns">
            <button class="btn primary" id="startBtn">Start / Resume</button>
            <button class="btn" id="submitBtn" style="display:none;">Submit</button>
            <button class="btn" id="resetBtn">Reset Topic Score</button>
          </div>

          <div class="msgBox" id="quizMsg">Ready.</div>
        </div>

        <div class="scoreBox">
          <div style="font-weight:900">Your Score</div>
          <div class="small">Quiz Score</div>
          <div class="bigScore" id="scoreValue">0</div>
        </div>
      </section>

      <!-- Right: AI Tutor Widget -->
      <section class="card">
        <h2>AI Tutor</h2>
        <div class="small">
          Students can ask Sci-Guru questions by Form and Topic. This uses your Render backend.
        </div>

        <!-- AI Widget mounts here -->
        <div id="sg-ai-widget"></div>

        <div class="divider"></div>

        <div class="small">
          If you still get “Not connected”, set your backend URL inside this file (near the bottom):
          <b>window.SG_BACKEND_URL</b>.
        </div>
      </section>

    </main>
  </section>

  <footer>© 2025 LEC Biotec • sales@lecbiotec.com • Harare, Zimbabwe</footer>
</div>

<script>
/* ===========================================================
   CONFIG: Put your Render backend URL here (NO trailing slash)
   =========================================================== */
window.SG_BACKEND_URL = "https://YOUR-RENDER-APP.onrender.com";

/* ===========================================================
   TOPICS + LAB LINKS (filenames MUST match your repo root)
   =========================================================== */
const TOPICS = [
  { id: 1,  name:"Laboratory Safety & Apparatus",
    desc:"Rules, safety symbols, apparatus identification, measuring cylinder meniscus.",
    labs:[{name:"Lab Apparatus Explorer", file:"sim-apparatus.html"}],
    quiz:null
  },
  { id: 2,  name:"Cells & Levels of Organisation",
    desc:"Plant vs animal cells, organelles, levels of organisation (cells → tissues → organs → systems).",
    labs:[
      {name:"Cells Hub", file:"sim-cells-hub.html"},
      {name:"Cell Labeling", file:"sim-cells-labels.html"},
      {name:"Levels of Organisation", file:"sim-levels.html"},
      {name:"Microscope Simulator", file:"sim-microscope.html"}
    ],
    quiz:{
      title:"Topic 2 • Cells (Inline Quiz)",
      intro:"Answer the questions then Submit.",
      questions:[
        {q:"Which structure controls cell activities?", type:"mc", options:["Cytoplasm","Nucleus","Cell membrane","Cell wall"], a:1},
        {q:"Which cell part is found in plant cells but NOT in animal cells?", type:"mc", options:["Nucleus","Cytoplasm","Cell wall","Cell membrane"], a:2},
        {q:"Chloroplasts are mainly responsible for…", type:"mc", options:["Respiration","Photosynthesis","Diffusion","Osmosis"], a:1},
        {q:"Correct order of organisation is…", type:"mc", options:["Organs → Cells → Tissues","Cells → Tissues → Organs","Tissues → Cells → Organs","Systems → Organs → Cells"], a:1},
      ]
    }
  },
  { id: 3,  name:"Nutrition",
    desc:"Balanced diet, nutrients (carbs, fats, proteins, vitamins, minerals, fibre, water).",
    labs:[{name:"(Lab coming) Balanced Diet Builder", file:"labs-hub.html"}],
    quiz:{
      title:"Topic 3 • Nutrition (Inline Quiz)",
      intro:"Answer and Submit.",
      questions:[
        {q:"Which nutrient is mainly for growth and repair?", type:"mc", options:["Carbohydrates","Proteins","Fats","Fibre"], a:1},
        {q:"Which nutrient helps food move through the digestive system?", type:"mc", options:["Fibre","Vitamins","Minerals","Protein"], a:0},
        {q:"Which provides the MAIN energy supply?", type:"mc", options:["Carbohydrates","Vitamins","Mineral salts","Water"], a:0},
        {q:"A balanced diet means…", type:"mc", options:["Eating only fruits","Eating correct types and amounts of nutrients","Eating only meat","Skipping meals"], a:1},
      ]
    }
  },
  { id: 4,  name:"Respiratory System",
    desc:"Breathing vs respiration, composition of air, tests for oxygen (glowing splint) and CO₂ (limewater).",
    labs:[{name:"(Lab coming) Gas Tests", file:"labs-hub.html"}],
    quiz:{
      title:"Topic 4 • Respiratory (Inline Quiz)",
      intro:"Answer and Submit.",
      questions:[
        {q:"Air is mostly…", type:"mc", options:["Oxygen","Nitrogen","Carbon dioxide","Hydrogen"], a:1},
        {q:"Limewater turns cloudy when…", type:"mc", options:["Oxygen is present","Carbon dioxide is present","Nitrogen is present","Water vapour is present"], a:1},
        {q:"Breathing is…", type:"mc", options:["Chemical reaction in cells","Physical movement of air in/out","Only happens in plants","The same as photosynthesis"], a:1},
        {q:"Respiration produces…", type:"mc", options:["Glucose + oxygen","Energy + carbon dioxide","Chlorophyll","Only water"], a:1},
      ]
    }
  },
  { id: 5,  name:"Transport Systems",
    desc:"Diffusion, osmosis, blood components (plasma, RBCs, WBCs, platelets).",
    labs:[{name:"(Lab coming) Diffusion & Osmosis", file:"labs-hub.html"}],
    quiz:{
      title:"Topic 5 • Transport (Inline Quiz)",
      intro:"Answer and Submit.",
      questions:[
        {q:"Diffusion is movement of particles from…", type:"mc", options:["Low to high concentration","High to low concentration","Cold to hot","Large to small"], a:1},
        {q:"Osmosis is movement of…", type:"mc", options:["Salt","Water through a partially permeable membrane","Oxygen","Blood cells"], a:1},
        {q:"Red blood cells mainly transport…", type:"mc", options:["Oxygen","Food","Platelets","Hormones"], a:0},
        {q:"Platelets help with…", type:"mc", options:["Digestion","Blood clotting","Breathing","Photosynthesis"], a:1},
      ]
    }
  },
  { id: 6,  name:"Reproductive Systems",
    desc:"Flower parts, pollination, fertilisation, puberty changes in humans.",
    labs:[{name:"(Lab coming) Flower Dissection", file:"labs-hub.html"}],
    quiz:{
      title:"Topic 6 • Reproduction (Inline Quiz)",
      intro:"Answer and Submit.",
      questions:[
        {q:"Male part of a flower is the…", type:"mc", options:["Stigma","Stamen","Ovary","Carpel"], a:1},
        {q:"Pollination is…", type:"mc", options:["Fusion of gametes","Transfer of pollen to stigma","Seed formation","Fruit formation"], a:1},
        {q:"Fertilisation forms a…", type:"mc", options:["Zygote","Spore","Leaf","Root"], a:0},
        {q:"Puberty is…", type:"mc", options:["Time body prepares for reproduction","A disease","A type of fertiliser","A food group"], a:0},
      ]
    }
  },
  { id: 7,  name:"Health & Diseases",
    desc:"Personal/food/environmental hygiene, waste disposal, infectious diseases & transmission.",
    labs:[{name:"(Lab coming) Hygiene Decision Game", file:"labs-hub.html"}],
    quiz:{
      title:"Topic 7 • Health (Inline Quiz)",
      intro:"Answer and Submit.",
      questions:[
        {q:"Cholera is commonly spread through…", type:"mc", options:["Clean water","Contaminated water/food","Air only","Sunlight"], a:1},
        {q:"Malaria is transmitted by…", type:"mc", options:["Snails","Mosquitoes","Flies","Dogs"], a:1},
        {q:"Recycling is done to…", type:"mc", options:["Increase waste","Reduce waste","Spread disease","Stop breathing"], a:1},
        {q:"Personal hygiene means…", type:"mc", options:["Keeping yourself clean","Only washing clothes","Only cleaning the yard","Only cooking food"], a:0},
      ]
    }
  },

  /* Chemistry + Physics Topics (keep them visible — you already reached 19) */
  { id: 8,  name:"Separation", desc:"Filtration, magnetism, decanting, evaporation, winnowing.", labs:[{name:"Separation Lab", file:"sim-separation.html"}], quiz:null },
  { id: 9,  name:"Matter", desc:"States of matter, kinetic theory, changes of state, solubility.", labs:[{name:"(Lab coming) Matter Lab", file:"labs-hub.html"}], quiz:null },
  { id: 10, name:"Acids, Bases & Salts", desc:"Indicators, properties, neutralisation.", labs:[{name:"(Lab coming) Acids/Bases", file:"labs-hub.html"}], quiz:null },
  { id: 11, name:"Industrial Processes", desc:"Peanut butter/oil processing steps.", labs:[{name:"(Lab coming) Industrial", file:"labs-hub.html"}], quiz:null },
  { id: 12, name:"Oxidation", desc:"Rusting & prevention (painting, galvanising, electroplating).", labs:[{name:"(Lab coming) Rusting", file:"labs-hub.html"}], quiz:null },
  { id: 13, name:"Organic Chemistry", desc:"Fuels, combustion, fuel efficiency.", labs:[{name:"(Lab coming) Fuels", file:"labs-hub.html"}], quiz:null },
  { id: 14, name:"Data Presentation", desc:"Tables, tallies, bar graphs.", labs:[{name:"(Lab coming) Chart Builder", file:"labs-hub.html"}], quiz:null },
  { id: 15, name:"Measurements", desc:"SI units, instruments, errors.", labs:[{name:"Open Measurements Lab", file:"sim-apparatus.html"}], quiz:null },
  { id: 16, name:"Force", desc:"Types of forces, weight, newton, friction.", labs:[{name:"(Lab coming) Forces", file:"labs-hub.html"}], quiz:null },
  { id: 17, name:"Energy", desc:"Forms of energy, conversions, sources.", labs:[{name:"(Lab coming) Energy", file:"labs-hub.html"}], quiz:null },
  { id: 18, name:"Magnetism", desc:"Poles, magnetic field, electromagnets.", labs:[{name:"(Lab coming) Magnetism", file:"labs-hub.html"}], quiz:null },
  { id: 19, name:"Electricity", desc:"Static vs current, conductors/insulators, circuit components & symbols.", labs:[{name:"Electricity Simulator", file:"sim-electricity.html"}], quiz:null },
];

const LS_SELECTED_TOPIC = "sg_selected_topic";
const LS_SCORE_PREFIX = "sg_topic_score_";

/* ===========================================================
   RENDER TOPIC LIST
   =========================================================== */
const topicListEl = document.getElementById("topicList");

function renderTopicList(activeId){
  topicListEl.innerHTML = "";
  TOPICS.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "topicBtn" + (t.id===activeId ? " active" : "");
    btn.innerHTML = `<span>Topic ${t.id}</span><span class="topicTag">${t.name.split(" ")[0]}</span>`;
    btn.onclick = ()=>selectTopic(t.id);
    topicListEl.appendChild(btn);
  });
}

/* ===========================================================
   TOPIC CARD + LABS + QUIZ
   =========================================================== */
const topicTitleEl = document.getElementById("topicTitle");
const topicDescEl  = document.getElementById("topicDesc");
const labListEl    = document.getElementById("labList");
const quizTitleEl  = document.getElementById("quizTitle");
const quizDescEl   = document.getElementById("quizDesc");
const quizIntroEl  = document.getElementById("quizIntro");
const quizQuestionsEl = document.getElementById("quizQuestions");
const quizMsgEl    = document.getElementById("quizMsg");
const scoreValueEl = document.getElementById("scoreValue");
const startBtn     = document.getElementById("startBtn");
const submitBtn    = document.getElementById("submitBtn");
const resetBtn     = document.getElementById("resetBtn");

let currentTopicId = Number(localStorage.getItem(LS_SELECTED_TOPIC)) || 1;
let quizLoaded = false;

function getTopic(id){ return TOPICS.find(t=>t.id===id); }
function scoreKey(id){ return LS_SCORE_PREFIX + id; }

function setScore(id, val){
  localStorage.setItem(scoreKey(id), String(val));
  scoreValueEl.textContent = String(val);
}
function getScore(id){
  return Number(localStorage.getItem(scoreKey(id)) || "0");
}

function renderLabs(topic){
  labListEl.innerHTML = "";
  (topic.labs||[]).forEach(l=>{
    const item = document.createElement("div");
    item.className = "labItem";
    item.innerHTML = `
      <div>
        <div class="labName">${l.name}</div>
        <div class="small">File: <b>${l.file}</b></div>
      </div>
      <button class="openLink" onclick="location.href='${l.file}'">Open →</button>
    `;
    labListEl.appendChild(item);
  });
}

function buildQuizUI(topic){
  quizQuestionsEl.innerHTML = "";
  quizLoaded = false;

  if(!topic.quiz){
    quizTitleEl.textContent = `Topic ${topic.id} • ${topic.name} — Inline Quiz`;
    quizDescEl.textContent  = "Quiz coming (your progress is not erased).";
    quizIntroEl.innerHTML   = "No quiz file yet for this topic. You can still use the labs and AI Tutor.";
    quizQuestionsEl.style.display = "none";
    submitBtn.style.display = "none";
    return;
  }

  quizTitleEl.textContent = topic.quiz.title || `Topic ${topic.id} Quiz`;
  quizDescEl.textContent  = topic.quiz.intro || "Answer and submit.";

  // Build questions (MC only here to keep it clean)
  topic.quiz.questions.forEach((qq, idx)=>{
    const qWrap = document.createElement("div");
    qWrap.className = "qRow";
    const selectId = `q_${topic.id}_${idx}`;
    qWrap.innerHTML = `
      <div class="small"><b>${idx+1})</b> ${qq.q}</div>
      <select id="${selectId}">
        <option value="">Choose…</option>
        ${qq.options.map((o,i)=>`<option value="${i}">${o}</option>`).join("")}
      </select>
    `;
    quizQuestionsEl.appendChild(qWrap);
  });

  quizIntroEl.innerHTML = "Click <b>Start / Resume</b> to load this topic quiz.";
  quizQuestionsEl.style.display = "none";
  submitBtn.style.display = "none";
}

function selectTopic(id){
  const topic = getTopic(id);
  if(!topic) return;

  currentTopicId = id;
  localStorage.setItem(LS_SELECTED_TOPIC, String(id));
  renderTopicList(id);

  topicTitleEl.textContent = `Topic ${topic.id} • ${topic.name}`;
  topicDescEl.textContent  = topic.desc || "";

  renderLabs(topic);
  buildQuizUI(topic);

  setScore(topic.id, getScore(topic.id));

  quizMsgEl.textContent = "Ready.";
}

startBtn.onclick = ()=>{
  const topic = getTopic(currentTopicId);
  if(!topic) return;

  if(!topic.quiz){
    quizMsgEl.innerHTML = `<span class="statusBad">No quiz yet</span> for Topic ${topic.id}. Use labs + AI Tutor.`;
    return;
  }

  quizLoaded = true;
  quizQuestionsEl.style.display = "";
  submitBtn.style.display = "";
  quizIntroEl.innerHTML = `<span class="statusOk">Quiz loaded ✓</span> Answer and press Submit.`;
  quizMsgEl.textContent = "Answer all questions.";
};

submitBtn.onclick = ()=>{
  const topic = getTopic(currentTopicId);
  if(!topic || !topic.quiz) return;

  let score = 0;
  let total = topic.quiz.questions.length;

  topic.quiz.questions.forEach((qq, idx)=>{
    const sel = document.getElementById(`q_${topic.id}_${idx}`);
    const v = sel ? sel.value : "";
    if(v !== "" && Number(v) === qq.a) score++;
  });

  setScore(topic.id, score);
  const pct = Math.round((score/total)*100);
  quizMsgEl.innerHTML = (score===total)
    ? `<span class="statusOk">Excellent ✅</span> You got ${score}/${total} (${pct}%).`
    : `<span class="statusBad">Try again ❌</span> You got ${score}/${total} (${pct}%).`;
};

resetBtn.onclick = ()=>{
  setScore(currentTopicId, 0);
  quizMsgEl.textContent = "Score reset for this topic.";
};

/* ===========================================================
   LINK CHECK (best-effort)
   =========================================================== */
const linkStatusEl = document.getElementById("linkStatus");
async function checkLink(file){
  try{
    const res = await fetch(file, {method:"GET", cache:"no-store"});
    return res.ok;
  }catch(e){ return false; }
}
async function checkAllLinks(){
  const files = new Set();
  TOPICS.forEach(t => (t.labs||[]).forEach(l => files.add(l.file)));
  let okCount = 0;
  let total = files.size;
  for(const f of files){
    const ok = await checkLink(f);
    if(ok) okCount++;
  }
  linkStatusEl.textContent = (okCount===total)
    ? "Links: OK ✓"
    : `Links: ${okCount}/${total} OK`;
}
checkAllLinks();

/* ===========================================================
   INIT
   =========================================================== */
selectTopic(currentTopicId);

/* ===========================================================
   ===========================================================
   SCI-GURU AI WIDGET (INCLUDED INSIDE tutor.html)
   ===========================================================
   =========================================================== */
(function(){
  const DEFAULT_BACKEND = "";
  const BACKEND_URL = (window.SG_BACKEND_URL || DEFAULT_BACKEND || "").replace(/\/+$/,"");
  const ENDPOINTS = ["/api/chat", "/chat"];
  const LS_KEY = "sg_chat_history_v1";

  const mountEl = document.getElementById("sg-ai-widget");
  if(!mountEl) return;

  mountEl.innerHTML = `
    <div class="sgw-head">
      <div>
        <div class="sgw-title">
          <span class="sgw-dot" id="sgwDot"></span>
          <div>
            Sci-Guru Tutor Chat
            <div class="sgw-sub" id="sgwStatus">Not connected</div>
          </div>
        </div>
      </div>
      <div class="sgw-actions">
        <button class="sgw-btn" id="sgwClear">Clear</button>
        <button class="sgw-btn" id="sgwTest">Test</button>
      </div>
    </div>

    <div class="sgw-body">
      <div class="sgw-row">
        <div class="sgw-mini">
          <div class="small" style="margin-bottom:6px"><b>Form</b></div>
          <select id="sgwForm">
            <option value="Form 1" selected>Form 1</option>
            <option value="Form 2">Form 2</option>
            <option value="Form 3">Form 3</option>
            <option value="Form 4">Form 4</option>
          </select>
        </div>
        <div class="sgw-mini">
          <div class="small" style="margin-bottom:6px"><b>Topic</b> (auto from left)</div>
          <input id="sgwTopic" placeholder="e.g., Nutrition, Respiration, Electricity"/>
        </div>
      </div>

      <div class="sgw-chips">
        <button class="sgw-chip" data-q="Explain this topic simply.">Explain simply</button>
        <button class="sgw-chip" data-q="Give me 5 revision questions with answers.">Revision Qs</button>
        <button class="sgw-chip" data-q="Give me a practical experiment I can do at school.">Practical</button>
        <button class="sgw-chip" data-q="Make a 10-question quiz.">Quiz</button>
      </div>

      <div class="sgw-chat" id="sgwChat"></div>

      <div class="sgw-compose">
        <input id="sgwInput" placeholder="Type your question… (Press Enter to send)"/>
        <button class="sgw-send" id="sgwSend">Send</button>
      </div>

      <div class="sgw-hint">
        Backend: <b>${BACKEND_URL ? BACKEND_URL : "NOT SET"}</b>
      </div>
    </div>
  `;

  const dot = document.getElementById("sgwDot");
  const statusEl = document.getElementById("sgwStatus");
  const chatEl = document.getElementById("sgwChat");
  const formEl = document.getElementById("sgwForm");
  const topicEl = document.getElementById("sgwTopic");
  const inputEl = document.getElementById("sgwInput");
  const sendBtn = document.getElementById("sgwSend");
  const clearBtn = document.getElementById("sgwClear");
  const testBtn = document.getElementById("sgwTest");

  function nowTime(){
    return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }
  function safeParse(json, fallback){
    try{return JSON.parse(json);}catch(e){return fallback;}
  }
  function loadHistory(){
    const data = safeParse(localStorage.getItem(LS_KEY), []);
    return Array.isArray(data) ? data : [];
  }
  function saveHistory(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(-40)));
  }
  function addMsg(role, text, t=nowTime(), save=true){
    const wrap = document.createElement("div");
    wrap.className = "sgw-msg " + (role==="user" ? "user" : "bot");
    wrap.innerHTML = `<div class="sgw-bubble"><b style="font-size:12px;opacity:.75">${role==="user"?"You":"Sci-Guru"} • ${t}</b><br>${(text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>`;
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;

    if(save){
      const hist = loadHistory();
      hist.push({role, text, time:t});
      saveHistory(hist);
    }
  }

  // Load saved chat
  loadHistory().forEach(m => addMsg(m.role, m.text, m.time, false));
  chatEl.scrollTop = chatEl.scrollHeight;

  // Keep topic field synced with selected topic
  function syncTopic(){
    const t = getTopic(currentTopicId);
    if(t) topicEl.value = t.name;
  }
  syncTopic();

  // When user clicks topic, update widget topic too
  const originalSelectTopic = selectTopic;
  window.selectTopic = function(id){
    originalSelectTopic(id);
    syncTopic();
  };

  async function detectEndpoint(){
    if(!BACKEND_URL) return null;
    for(const ep of ENDPOINTS){
      try{
        const res = await fetch(BACKEND_URL + ep, {method:"OPTIONS"});
        if(res) return ep; // if it responds, we assume endpoint exists
      }catch(e){}
    }
    // fallback: try first endpoint anyway
    return ENDPOINTS[0];
  }

  let chosenEndpoint = null;

  async function setConnected(ok, msg){
    if(ok){
      dot.classList.add("ok");
      statusEl.textContent = msg || "Connected";
    }else{
      dot.classList.remove("ok");
      statusEl.textContent = msg || "Not connected";
    }
  }

  async function testConnection(){
    if(!BACKEND_URL){
      setConnected(false, "Backend URL not set");
      return;
    }
    chosenEndpoint = await detectEndpoint();
    // quick ping by sending a tiny message
    try{
      const payload = { message:"ping", form: formEl.value, topic: topicEl.value };
      const res = await fetch(BACKEND_URL + chosenEndpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("HTTP " + res.status);
      setConnected(true, "Connected ✓");
    }catch(e){
      setConnected(false, "Backend not reachable");
    }
  }

  async function send(){
    const text = (inputEl.value || "").trim();
    if(!text) return;

    addMsg("user", text);
    inputEl.value = "";
    sendBtn.disabled = true;

    // If backend not set: offline fallback
    if(!BACKEND_URL){
      addMsg("bot", "Backend URL is not set. Ask your teacher/admin to set window.SG_BACKEND_URL to your Render link.");
      sendBtn.disabled = false;
      return;
    }

    if(!chosenEndpoint) chosenEndpoint = ENDPOINTS[0];

    const payload = {
      message: text,
      form: formEl.value,
      topic: topicEl.value || (getTopic(currentTopicId)?.name || "")
    };

    try{
      const res = await fetch(BACKEND_URL + chosenEndpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error("HTTP " + res.status);

      const ct = res.headers.get("content-type") || "";
      let replyText = "";
      if(ct.includes("application/json")){
        const data = await res.json();
        replyText =
          data.reply || data.answer || data.message || data.response ||
          (typeof data === "string" ? data : JSON.stringify(data, null, 2));
      }else{
        replyText = await res.text();
      }

      setConnected(true, "Connected ✓");
      addMsg("bot", replyText || "OK");
    }catch(e){
      setConnected(false, "Backend not reachable");
      addMsg("bot", "I could not reach the AI server. Check your Render URL and endpoint (/api/chat or /chat).");
    }finally{
      sendBtn.disabled = false;
    }
  }

  // Chips
  document.querySelectorAll("#sg-ai-widget .sgw-chip").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      inputEl.value = btn.getAttribute("data-q") || "";
      inputEl.focus();
    });
  });

  // Buttons
  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });

  clearBtn.addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    chatEl.innerHTML = "";
    addMsg("bot", "Chat cleared. Ask a new question anytime.", nowTime(), false);
  });

  testBtn.addEventListener("click", testConnection);

  // Start with a sync + optional test
  setConnected(false, BACKEND_URL ? "Click Test" : "Backend URL not set");
})();
</script>

</body>
</html>
