<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sci-Guru AI Science Tutor</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="app-body">

  <!-- TOP NAVBAR -->
  <header class="top-nav">
    <div class="brand">
      <img src="lec-logo.jpg" alt="LEC Biotec Logo" class="brand-logo" />
      <span class="brand-name">Sci-Guru</span>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="tutor.html" class="active">AI Tutor</a>
      <a href="#virtual-labs" onclick="openVirtualLabHub()">Virtual Labs</a>
    </nav>
  </header>

  <!-- MAIN LAYOUT -->
  <main class="tutor-layout">
    <!-- ASK SCI-GURU PANEL -->
    <section class="tutor-panel">
      <h1 class="panel-title">Ask Sci-Guru</h1>
      <p class="panel-subtitle">
        Choose a form and topic, then ask your question in simple English.
      </p>

      <div class="form-row">
        <label for="form-level">Form / Level</label>
        <select id="form-level">
          <option value="Form 1" selected>Form 1</option>
          <option value="Form 2">Form 2</option>
          <option value="Form 3">Form 3</option>
          <option value="Form 4">Form 4</option>
        </select>
      </div>

      <div class="form-row">
        <label for="topic">Topic (Form 1 chapters + general)</label>
        <select id="topic">
          <option value="">-- Optional: choose a topic --</option>

          <!-- General / mixed topics -->
          <optgroup label="General">
            <option value="General Science">General Science</option>
          </optgroup>

          <!-- FORM 1 CHAPTERS 1–17 -->
          <optgroup label="Form 1 – Chapters">
            <option value="Living things and characteristics of life">
              Chapter 1 – Living things and characteristics of life
            </option>
            <option value="Cells and simple microscopes">
              Chapter 2 – Cells and simple microscopes
            </option>
            <option value="Human body systems and hygiene">
              Chapter 3 – Human body systems and hygiene
            </option>
            <option value="Ecosystems and environment">
              Chapter 4 – Ecosystems and environment
            </option>
            <option value="States of matter">
              Chapter 5 – States of matter
            </option>
            <option value="Mixtures and separation methods">
              Chapter 6 – Mixtures and separation methods
            </option>
            <option value="Density and flotation">
              Chapter 7 – Density and flotation
            </option>
            <option value="Electricity and magnetism">
              Chapter 8 – Electricity and magnetism
            </option>
            <option value="Energy and fuels">
              Chapter 9 – Energy and fuels
            </option>
            <option value="Light">
              Chapter 10 – Light
            </option>
            <option value="Sound">
              Chapter 11 – Sound
            </option>
            <option value="Heat and temperature">
              Chapter 12 – Heat and temperature
            </option>
            <option value="Weather and climate">
              Chapter 13 – Weather and climate
            </option>
            <option value="Earth and space">
              Chapter 14 – Earth and space
            </option>
            <option value="Machines and pressure">
              Chapter 15 – Simple machines and pressure
            </option>
            <option value="Acids bases and salts">
              Chapter 16 – Acids, bases and salts
            </option>
            <option value="Scientific methods and safety">
              Chapter 17 – Scientific methods and safety
            </option>
          </optgroup>
        </select>
      </div>

      <div class="form-row">
        <label for="question">Your question</label>
        <textarea id="question" rows="4"
          placeholder="Explain density using Zimbabwean examples..."></textarea>
      </div>

      <div class="button-row">
        <button id="ask-btn" class="primary-btn">Ask Sci-Guru</button>
        <button id="quiz-btn" class="secondary-btn">Generate quiz</button>
      </div>

      <div class="button-row">
        <button id="practical-btn" class="ghost-btn">Generate practical</button>
        <button type="button" class="ghost-btn" onclick="openVirtualLabHub()">
          Open virtual lab hub
        </button>
      </div>

      <!-- TOPIC SCORE SAVE -->
      <div class="score-save-row">
        <label class="score-checkbox">
          <input type="checkbox" id="save-score-checkbox" checked />
          I want to save my quiz result for this topic
        </label>
        <div class="score-input">
          <span>I scored</span>
          <input type="number" id="score-input" min="0" max="100"
                 placeholder="e.g. 75" />
          <span>%</span>
        </div>
        <button id="save-score-btn" class="small-primary-btn">
          Save topic score
        </button>
      </div>

      <p class="backend-status">
        Sci-Guru is ready. Backend: <span id="backend-status-text">LIVE.</span>
      </p>
    </section>

    <!-- RESULTS PANEL -->
    <section class="results-panel">
      <h2>Results</h2>

      <div class="result-card">
        <h3>Explanation</h3>
        <div id="explanation-output" class="result-content">
          Sci-Guru will answer here...
        </div>
      </div>

      <div class="result-card">
        <h3>Quiz</h3>
        <div id="quiz-output" class="result-content">
          Quiz will appear here...
        </div>
      </div>

      <div class="result-card">
        <h3>Practical</h3>
        <div id="practical-output" class="result-content">
          Practical experiment will appear here...
        </div>
      </div>
    </section>

    <!-- RIGHT PANEL – CHAPTERS + LAB PROGRESS -->
    <aside class="progress-panel">
      <h2>Form 1 Chapters</h2>
      <p class="progress-caption">Saved on this device</p>

      <h3>Chapters (best quiz score)</h3>
      <ul id="topic-progress-list" class="progress-list">
        <li data-topic="Living things and characteristics of life">
          <span>Chapter 1 – Living things &amp; characteristics of life</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Cells and simple microscopes">
          <span>Chapter 2 – Cells and simple microscopes</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Human body systems and hygiene">
          <span>Chapter 3 – Human body systems &amp; hygiene</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Ecosystems and environment">
          <span>Chapter 4 – Ecosystems &amp; environment</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="States of matter">
          <span>Chapter 5 – States of matter</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Mixtures and separation methods">
          <span>Chapter 6 – Mixtures &amp; separation methods</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Density and flotation">
          <span>Chapter 7 – Density &amp; flotation</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Electricity and magnetism">
          <span>Chapter 8 – Electricity &amp; magnetism</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Energy and fuels">
          <span>Chapter 9 – Energy &amp; fuels</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Light">
          <span>Chapter 10 – Light</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Sound">
          <span>Chapter 11 – Sound</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Heat and temperature">
          <span>Chapter 12 – Heat &amp; temperature</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Weather and climate">
          <span>Chapter 13 – Weather &amp; climate</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Earth and space">
          <span>Chapter 14 – Earth &amp; space</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Machines and pressure">
          <span>Chapter 15 – Simple machines &amp; pressure</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Acids bases and salts">
          <span>Chapter 16 – Acids, bases &amp; salts</span>
          <span class="topic-score">Best: --%</span>
        </li>
        <li data-topic="Scientific methods and safety">
          <span>Chapter 17 – Scientific methods &amp; safety</span>
          <span class="topic-score">Best: --%</span>
        </li>
      </ul>

      <h3>Virtual labs (completion)</h3>
      <ul class="progress-list">
        <li data-lab-key="living-things-lab">
          <span>Living Things Lab</span>
          <span class="lab-status">Not done</span>
        </li>
        <li data-lab-key="density-lab">
          <span>Density Lab</span>
          <span class="lab-status">Not done</span>
        </li>
        <li data-lab-key="mixtures-lab">
          <span>Mixtures Lab</span>
          <span class="lab-status">Not done</span>
        </li>
        <li data-lab-key="electricity-lab">
          <span>Electricity Lab</span>
          <span class="lab-status">Not done</span>
        </li>
      </ul>
    </aside>
  </main>

  <footer class="app-footer">
    <span>&copy; 2025 LEC BIOTEC. All rights reserved.</span>
  </footer>

  <!-- SCRIPT: API CALLS + PROGRESS STORAGE -->
  <script>
    const API_BASE = "https://sci-guru-backend.onrender.com/api";

    const formSelect = document.getElementById("form-level");
    const topicSelect = document.getElementById("topic");
    const questionInput = document.getElementById("question");

    const explanationOutput = document.getElementById("explanation-output");
    const quizOutput = document.getElementById("quiz-output");
    const practicalOutput = document.getElementById("practical-output");

    const askBtn = document.getElementById("ask-btn");
    const quizBtn = document.getElementById("quiz-btn");
    const practicalBtn = document.getElementById("practical-btn");

    const saveScoreCheckbox = document.getElementById("save-score-checkbox");
    const scoreInput = document.getElementById("score-input");
    const saveScoreBtn = document.getElementById("save-score-btn");

    const backendStatusText = document.getElementById("backend-status-text");

    // ---------- API HELPERS ----------
    async function callApi(endpoint, body) {
      try {
        const res = await fetch(\`\${API_BASE}/\${endpoint}\`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          console.error("API error", res.status, await res.text());
          return { error: "Server error. Please try again." };
        }

        const data = await res.json();
        return data;
      } catch (err) {
        console.error("Network error", err);
        return { error: "Network error. Check your connection." };
      }
    }

    function setLoading(target, isLoading) {
      const msg = isLoading ? "Sci-Guru is thinking..." : "";
      target.textContent = msg;
    }

    // ---------- BUTTON HANDLERS ----------
    askBtn.addEventListener("click", async () => {
      const form = formSelect.value || "Form 1";
      const topic = topicSelect.value || "General Science";
      const question = questionInput.value.trim();

      if (!question) {
        explanationOutput.textContent = "Please type a question first.";
        return;
      }

      setLoading(explanationOutput, true);
      const data = await callApi("explain", { form, topic, question });
      setLoading(explanationOutput, false);

      if (data.error) {
        explanationOutput.textContent = data.error;
      } else {
        explanationOutput.textContent = data.answer || "No answer returned.";
      }
    });

    quizBtn.addEventListener("click", async () => {
      const form = formSelect.value || "Form 1";
      const topic = topicSelect.value || "General Science";
      const question = questionInput.value.trim() || "Create a quiz for this topic.";

      setLoading(quizOutput, true);
      const data = await callApi("quiz", { form, topic, question });
      setLoading(quizOutput, false);

      if (data.error) {
        quizOutput.textContent = data.error;
      } else {
        quizOutput.textContent = data.quiz || "No quiz generated.";
      }
    });

    practicalBtn.addEventListener("click", async () => {
      const form = formSelect.value || "Form 1";
      const topic = topicSelect.value || "General Science";
      const question = questionInput.value.trim() || "Generate a practical for this topic.";

      setLoading(practicalOutput, true);
      const data = await callApi("practical", { form, topic, question });
      setLoading(practicalOutput, false);

      if (data.error) {
        practicalOutput.textContent = data.error;
      } else {
        practicalOutput.textContent = data.practical || "No practical generated.";
      }
    });

    // ---------- LOCAL STORAGE: TOPIC SCORES ----------
    const SCORE_KEY = "sciGuruTopicScores_v1";
    const LAB_KEY = "sciGuruLabCompletion_v1";

    function loadScores() {
      try {
        return JSON.parse(localStorage.getItem(SCORE_KEY)) || {};
      } catch {
        return {};
      }
    }

    function saveScores(scores) {
      localStorage.setItem(SCORE_KEY, JSON.stringify(scores));
    }

    function loadLabCompletion() {
      try {
        return JSON.parse(localStorage.getItem(LAB_KEY)) || {};
      } catch {
        return {};
      }
    }

    function saveLabCompletion(labs) {
      localStorage.setItem(LAB_KEY, JSON.stringify(labs));
    }

    function renderTopicProgress() {
      const scores = loadScores();
      const items = document.querySelectorAll("#topic-progress-list li");

      items.forEach((li) => {
        const topic = li.getAttribute("data-topic");
        const span = li.querySelector(".topic-score");
        const best = scores[topic];

        if (best != null) {
          span.textContent = \`Best: \${best}%\`;
          li.classList.add("has-score");
        } else {
          span.textContent = "Best: --%";
          li.classList.remove("has-score");
        }
      });
    }

    function renderLabProgress() {
      const labs = loadLabCompletion();
      const items = document.querySelectorAll(".progress-list li[data-lab-key]");

      items.forEach((li) => {
        const key = li.getAttribute("data-lab-key");
        const span = li.querySelector(".lab-status");
        const done = !!labs[key];

        if (done) {
          span.textContent = "Done";
          li.classList.add("lab-done");
        } else {
          span.textContent = "Not done";
          li.classList.remove("lab-done");
        }
      });
    }

    // Called from lab pages like sim-density.html
    function markLabCompleted(labKey) {
      const labs = loadLabCompletion();
      labs[labKey] = true;
      saveLabCompletion(labs);
      renderLabProgress();
    }

    // Save score button
    saveScoreBtn.addEventListener("click", () => {
      if (!saveScoreCheckbox.checked) return;

      const topic = topicSelect.value || "General Science";
      const raw = scoreInput.value.trim();
      const score = Number(raw);

      if (isNaN(score) || score < 0 || score > 100) {
        alert("Please enter a valid score between 0 and 100.");
        return;
      }

      const scores = loadScores();
      const previous = scores[topic];

      if (previous == null || score > previous) {
        scores[topic] = score;
        saveScores(scores);
        renderTopicProgress();
        alert("Best score saved for this topic.");
      } else {
        alert("You already have a higher or equal best score for this topic.");
      }
    });

    // ---------- VIRTUAL LAB HUB ----------
    function openVirtualLabHub() {
      // For now just scroll the user to the Virtual Labs section on home,
      // or open density lab directly in a new tab.
      window.open("sim-density.html", "_blank");
    }

    // Expose markLabCompleted for other pages
    window.markLabCompleted = markLabCompleted;
    window.openVirtualLabHub = openVirtualLabHub;

    // ---------- INIT ----------
    renderTopicProgress();
    renderLabProgress();

    // Quick backend health check (optional)
    (async function pingBackend() {
      try {
        const res = await fetch(API_BASE + "/health");
        backendStatusText.textContent = res.ok ? "LIVE." : "Not responding.";
      } catch {
        backendStatusText.textContent = "Offline (check internet).";
      }
    })();
  </script>
</body>
</html>
