<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sci-Guru AI Science Tutor</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body class="tutor-body">
    <!-- Top Navigation -->
    <header class="top-nav">
        <div class="nav-left">
            <img src="lec-logo.jpg" alt="LEC Biotec Logo" class="lec-logo" />
            <div class="nav-title-group">
                <div class="nav-title">Sci-Guru AI Science Tutor</div>
                <div class="nav-subtitle">
                    Zimbabwe’s AI-powered tutor for the ZIMSEC / Heritage-Based curriculum
                </div>
            </div>
        </div>
        <nav class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="tutor.html" class="nav-link nav-link-active">AI Tutor</a>
        </nav>
    </header>

    <!-- Main Tutor Layout -->
    <main class="tutor-main">
        <!-- Left column: Ask Sci-Guru -->
        <section class="tutor-panel tutor-panel-left">
            <h2 class="panel-heading">Ask Sci-Guru</h2>
            <p class="panel-subtext">
                Choose a form and topic, then ask your question in simple English.
            </p>

            <!-- Form / Level -->
            <label class="field-label" for="formLevel">Form / Level</label>
            <select id="formLevel" class="field-select">
                <option value="Form 1" selected>Form 1</option>
                <option value="Form 2">Form 2</option>
                <option value="Form 3">Form 3</option>
                <option value="Form 4">Form 4</option>
            </select>

            <!-- Topic (grouped, but still optional) -->
            <label class="field-label" for="topic">
                Topic (Form 1 topics grouped + general)
            </label>
            <select id="topic" class="field-select">
                <option value="">-- Optional: choose a topic --</option>

                <optgroup label="General">
                    <option value="General science">
                        General science & revision
                    </option>
                    <option value="Everyday science">
                        Everyday science in Zimbabwe
                    </option>
                </optgroup>

                <optgroup label="Form 1 — Biology">
                    <option value="Living things and characteristics of life">
                        Living things & characteristics of life
                    </option>
                    <option value="Cells and simple microscopes">
                        Cells and simple microscopes
                    </option>
                    <option value="Human body systems and hygiene">
                        Human body systems & hygiene
                    </option>
                    <option value="Ecosystems and environment">
                        Ecosystems & environment
                    </option>
                </optgroup>

                <optgroup label="Form 1 — Physical & Chemical">
                    <option value="States of matter">
                        States of matter
                    </option>
                    <option value="Mixtures and separation methods">
                        Mixtures & separation methods
                    </option>
                    <option value="Density and flotation">
                        Density & flotation
                    </option>
                    <option value="Electricity and magnetism">
                        Electricity & magnetism
                    </option>
                </optgroup>

                <optgroup label="Form 1 — Skills & Projects">
                    <option value="Scientific skills and safety">
                        Scientific skills & safety
                    </option>
                    <option value="Simple laboratory apparatus">
                        Simple laboratory apparatus
                    </option>
                    <option value="Project work and investigations">
                        Project work & investigations
                    </option>
                    <option value="Science, technology and careers">
                        Science, technology & careers
                    </option>
                </optgroup>
            </select>

            <!-- Question -->
            <label class="field-label" for="question">Your question</label>
            <textarea
                id="question"
                class="field-textarea"
                rows="4"
                placeholder="Explain density using Zimbabwean examples..."
            ></textarea>

            <!-- Buttons row -->
            <div class="button-row">
                <button id="askBtn" class="primary-btn">Ask Sci-Guru</button>
                <button id="quizBtn" class="secondary-btn">Generate quiz</button>
            </div>

            <div class="button-row">
                <button id="practicalBtn" class="secondary-outline-btn">
                    Generate practical
                </button>
                <button
                    id="openLabHubBtn"
                    class="secondary-outline-btn"
                    type="button"
                >
                    Open virtual lab hub
                </button>
            </div>

            <!-- Save score section -->
            <div class="save-score-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="saveScoreCheckbox" checked />
                    <span>I want to save my quiz result for this topic</span>
                </label>
                <div class="score-input-row">
                    <span class="score-prefix">I scored</span>
                    <input
                        type="number"
                        id="scoreInput"
                        min="0"
                        max="100"
                        placeholder="e.g. 75"
                        class="score-input"
                    />
                    <span class="score-suffix">%</span>
                    <button id="saveScoreBtn" class="score-save-btn">
                        Save topic score
                    </button>
                </div>
            </div>

            <p class="backend-status">
                Sci-Guru is ready. Backend:
                <span id="backendStatusText">LIVE.</span>
            </p>
        </section>

        <!-- Right column: Results + chapters -->
        <section class="tutor-panel tutor-panel-right">
            <div class="results-header">
                <h2 class="panel-heading">Results</h2>
                <div id="chapterStatus" class="chapter-status-text">
                    No chapter tag selected (you can still ask any question).
                </div>
            </div>

            <!-- Explanation -->
            <div class="result-card">
                <div class="result-title">EXPLANATION</div>
                <div id="explanation" class="result-body">
                    Sci-Guru will answer here...
                </div>
            </div>

            <!-- Quiz -->
            <div class="result-card">
                <div class="result-title">QUIZ</div>
                <div id="quiz" class="result-body">
                    Quiz will appear here...
                </div>
            </div>

            <!-- Practical -->
            <div class="result-card">
                <div class="result-title">PRACTICAL</div>
                <div id="practical" class="result-body">
                    Practical experiment will appear here...
                </div>
            </div>

            <!-- Form 1 Chapters strip -->
            <div class="chapter-strip">
                <div class="chapter-strip-header">
                    <span class="chapter-strip-title">Form 1 chapters</span>
                    <span class="chapter-strip-subtitle">
                        · Tap a chapter to auto-fill topic, sample question & experiment focus.
                    </span>
                </div>

                <div class="chapter-tags" id="chapterTags">
                    <button class="chapter-tag" data-chapter-id="ch-1">Ch. 1</button>
                    <button class="chapter-tag" data-chapter-id="ch-2">Ch. 2</button>
                    <button class="chapter-tag" data-chapter-id="ch-3">Ch. 3</button>
                    <button class="chapter-tag" data-chapter-id="ch-4">Ch. 4</button>
                    <button class="chapter-tag" data-chapter-id="ch-5">Ch. 5</button>
                    <button class="chapter-tag" data-chapter-id="ch-6">Ch. 6</button>
                    <button class="chapter-tag" data-chapter-id="ch-7">Ch. 7</button>
                    <button class="chapter-tag" data-chapter-id="ch-8">Ch. 8</button>
                    <button class="chapter-tag" data-chapter-id="ch-9">Ch. 9</button>
                    <button class="chapter-tag" data-chapter-id="ch-10">Ch. 10</button>
                    <button class="chapter-tag" data-chapter-id="ch-11">Ch. 11</button>
                    <button class="chapter-tag" data-chapter-id="ch-12">Ch. 12</button>
                    <button class="chapter-tag" data-chapter-id="ch-13">Ch. 13</button>
                    <button class="chapter-tag" data-chapter-id="ch-14">Ch. 14</button>
                    <button class="chapter-tag" data-chapter-id="ch-15">Ch. 15</button>
                    <button class="chapter-tag" data-chapter-id="ch-16">Ch. 16</button>
                    <button class="chapter-tag" data-chapter-id="ch-17">Ch. 17</button>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        © 2025 LEC BIOTEC. All rights reserved.
    </footer>

    <!-- ================== SCRIPT ================== -->
    <script>
        // ======== CONFIG ========
        const BACKEND_BASE_URL = "https://sci-guru-backend.onrender.com";

        // Map of chapter IDs to topics, sample questions & experiment focus
        const chapterConfigs = {
            "ch-1": {
                label: "Ch. 1 – Scientific skills & safety",
                topic: "Scientific skills and safety",
                question:
                    "Explain the basic laboratory safety rules for a Form 1 class in Zimbabwe.",
                experimentFocus:
                    "Demonstrating safe handling of common lab equipment and chemicals."
            },
            "ch-2": {
                label: "Ch. 2 – Cells and simple microscopes",
                topic: "Cells and simple microscopes",
                question:
                    "Describe the main parts of a simple light microscope and their functions.",
                experimentFocus:
                    "Using a simple microscope to observe onion cells or leaf epidermis."
            },
            "ch-3": {
                label: "Ch. 3 – Human body systems & hygiene",
                topic: "Human body systems and hygiene",
                question:
                    "Explain why personal hygiene is important for preventing disease in a school.",
                experimentFocus:
                    "Investigating the effect of hand-washing on the growth of microorganisms."
            },
            "ch-4": {
                label: "Ch. 4 – Ecosystems & environment",
                topic: "Ecosystems and environment",
                question:
                    "Describe the components of an ecosystem using a Zimbabwean example.",
                experimentFocus:
                    "Setting up a simple model ecosystem in a bottle or container."
            },
            "ch-5": {
                label: "Ch. 5 – States of matter",
                topic: "States of matter",
                question:
                    "Explain the three states of matter using local examples from Zimbabwe.",
                experimentFocus:
                    "Observing changes of state when heating and cooling water or other substances."
            },
            "ch-6": {
                label: "Ch. 6 – Mixtures & separation methods",
                topic: "Mixtures and separation methods",
                question:
                    "Describe three methods used to separate mixtures in everyday life.",
                experimentFocus:
                    "Separating a mixture of sand, salt, iron filings and water using different methods."
            },
            "ch-7": {
                label: "Ch. 7 – Density & flotation",
                topic: "Density and flotation",
                question:
                    "Explain why some objects float and others sink in water, using local examples.",
                experimentFocus:
                    "Comparing the density of different materials using improvised balances and water."
            },
            "ch-8": {
                label: "Ch. 8 – Electricity & magnetism",
                topic: "Electricity and magnetism",
                question:
                    "Explain the difference between conductors and insulators with Zimbabwean examples.",
                experimentFocus:
                    "Building a simple electric circuit to test everyday materials as conductors or insulators."
            },
            "ch-9": {
                label: "Ch. 9 – Simple laboratory apparatus",
                topic: "Simple laboratory apparatus",
                question:
                    "Describe common laboratory apparatus used in Form 1 science and their uses.",
                experimentFocus:
                    "Identifying and correctly using basic laboratory apparatus in simple experiments."
            },
            "ch-10": {
                label: "Ch. 10 – Measurement & units",
                topic: "Scientific skills and safety",
                question:
                    "Explain why accurate measurement is important in science and give examples.",
                experimentFocus:
                    "Measuring mass, volume and temperature using simple equipment or improvised tools."
            },
            "ch-11": {
                label: "Ch. 11 – Matter & particle model",
                topic: "States of matter",
                question:
                    "Use the particle model to explain why solids, liquids and gases behave differently.",
                experimentFocus:
                    "Using simple demonstrations to model particle arrangement in solids, liquids and gases."
            },
            "ch-12": {
                label: "Ch. 12 – Energy & its forms",
                topic: "Energy",
                question:
                    "List different forms of energy and give local examples for each form.",
                experimentFocus:
                    "Investigating energy changes, for example potential to kinetic energy on a ramp."
            },
            "ch-13": {
                label: "Ch. 13 – Environment & human activities",
                topic: "Ecosystems and environment",
                question:
                    "Explain how human activities in Zimbabwe can affect the environment.",
                experimentFocus:
                    "Surveying a local area to identify signs of pollution or environmental change."
            },
            "ch-14": {
                label: "Ch. 14 – Science fair & investigations",
                topic: "Project work and investigations",
                question:
                    "Describe the steps of carrying out a scientific investigation for a school science fair.",
                experimentFocus:
                    "Planning and carrying out a simple investigation using variables, controls and fair tests."
            },
            "ch-15": {
                label: "Ch. 15 – End-of-form revision",
                topic: "General science",
                question:
                    "Generate a mixed revision question set for Form 1 combined science.",
                experimentFocus:
                    "Designing a revision practical that combines skills from different Form 1 topics."
            },
            "ch-16": {
                label: "Ch. 16 – Project work & investigations",
                topic: "Project work and investigations",
                question:
                    "Suggest a Form 1 science project that uses simple materials found in Zimbabwean homes or schools.",
                experimentFocus:
                    "Planning and reporting a simple investigation (aim, hypothesis, method, results, conclusion)."
            },
            "ch-17": {
                label: "Ch. 17 – Science, technology & careers",
                topic: "Science, technology and careers",
                question:
                    "Explain how studying combined science in Form 1 can lead to future careers in Zimbabwe.",
                experimentFocus:
                    "Exploring how science is used in local industries such as mining, agriculture, health or energy."
            }
        };

        let currentChapterId = null;

        // ======== DOM ELEMENTS ========
        const formLevelSelect = document.getElementById("formLevel");
        const topicSelect = document.getElementById("topic");
        const questionInput = document.getElementById("question");

        const askBtn = document.getElementById("askBtn");
        const quizBtn = document.getElementById("quizBtn");
        const practicalBtn = document.getElementById("practicalBtn");
        const openLabHubBtn = document.getElementById("openLabHubBtn");

        const explanationBox = document.getElementById("explanation");
        const quizBox = document.getElementById("quiz");
        const practicalBox = document.getElementById("practical");

        const backendStatusText = document.getElementById("backendStatusText");

        const saveScoreCheckbox = document.getElementById("saveScoreCheckbox");
        const scoreInput = document.getElementById("scoreInput");
        const saveScoreBtn = document.getElementById("saveScoreBtn");

        const chapterTagsContainer = document.getElementById("chapterTags");
        const chapterStatus = document.getElementById("chapterStatus");

        // ======== BACKEND HEALTH CHECK ========
        async function checkBackendHealth() {
            try {
                const res = await fetch(BACKEND_BASE_URL + "/health");
                if (res.ok) {
                    backendStatusText.textContent = "LIVE.";
                    backendStatusText.classList.add("status-live");
                } else {
                    backendStatusText.textContent = "CHECK CONNECTION.";
                    backendStatusText.classList.add("status-down");
                }
            } catch (err) {
                backendStatusText.textContent = "OFFLINE?";
                backendStatusText.classList.add("status-down");
            }
        }

        // ======== CORE API CALL ========
        async function callTutorApi(mode) {
            // mode = 'ask' | 'quiz' | 'practical'
            const formLevel = formLevelSelect.value;
            const topic = topicSelect.value || "General science";
            const question =
                questionInput.value.trim() ||
                "Explain this Form 1 topic using Zimbabwean examples.";

            const payload = {
                formLevel,
                topic,
                question,
                mode,
                chapterId: currentChapterId,
                chapterConfig: currentChapterId
                    ? chapterConfigs[currentChapterId]
                    : null
            };

            // Simple UI feedback
            if (mode === "ask") {
                explanationBox.textContent = "Sci-Guru is thinking (loading...)";
            } else if (mode === "quiz") {
                quizBox.textContent = "Generating quiz questions...";
            } else if (mode === "practical") {
                practicalBox.textContent = "Designing a practical...";
            }

            try {
                const res = await fetch(BACKEND_BASE_URL + "/api/tutor", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    throw new Error("Server error");
                }

                const data = await res.json();

                if (data.explanation) {
                    explanationBox.textContent = data.explanation;
                }
                if (data.quiz) {
                    quizBox.textContent = data.quiz;
                }
                if (data.practical) {
                    practicalBox.textContent = data.practical;
                } else if (mode === "practical" && !data.practical) {
                    practicalBox.textContent = "No practical returned.";
                }
            } catch (err) {
                const msg =
                    "There was a problem talking to the Sci-Guru server. Please check your internet and try again.";
                if (mode === "ask") explanationBox.textContent = msg;
                if (mode === "quiz") quizBox.textContent = msg;
                if (mode === "practical") practicalBox.textContent = msg;
            }
        }

        // ======== BUTTON HANDLERS ========
        askBtn.addEventListener("click", () => callTutorApi("ask"));
        quizBtn.addEventListener("click", () => callTutorApi("quiz"));
        practicalBtn.addEventListener("click", () => callTutorApi("practical"));

        // Open virtual lab hub (Form 1 experiences page)
        function openVirtualLabHub() {
            window.open("sim-form1-experiences.html", "_blank");
        }
        openLabHubBtn.addEventListener("click", openVirtualLabHub);

        // ======== SAVE SCORE (localStorage) ========
        function getScoresKey() {
            const formLevel = formLevelSelect.value;
            const topic = topicSelect.value || "General";
            return `sciGuruScore_${formLevel}_${topic}`;
        }

        function saveTopicScore() {
            if (!saveScoreCheckbox.checked) return;
            const score = parseFloat(scoreInput.value);
            if (isNaN(score) || score < 0 || score > 100) {
                alert("Please enter a valid score between 0 and 100.");
                return;
            }
            const key = getScoresKey();
            const existing = localStorage.getItem(key);
            const best = existing ? Math.max(score, parseFloat(existing)) : score;
            localStorage.setItem(key, best.toString());
            alert("Best score for this topic saved: " + best + "%");
        }
        saveScoreBtn.addEventListener("click", saveTopicScore);

        // ======== CHAPTER TAG LOGIC ========
        function clearActiveChapter() {
            const tags = chapterTagsContainer.querySelectorAll(".chapter-tag");
            tags.forEach((btn) => btn.classList.remove("active"));
        }

        function applyChapterTag(chapterId) {
            const config = chapterConfigs[chapterId];
            if (!config) return;

            currentChapterId = chapterId;

            // Highlight active button
            clearActiveChapter();
            const btn = chapterTagsContainer.querySelector(
                `[data-chapter-id="${chapterId}"]`
            );
            if (btn) btn.classList.add("active");

            // Set topic dropdown if matching option exists
            let matched = false;
            for (const opt of topicSelect.options) {
                if (opt.value === config.topic) {
                    topicSelect.value = config.topic;
                    matched = true;
                    break;
                }
            }
            if (!matched) {
                topicSelect.value = "";
            }

            // Auto-fill question
            questionInput.value = config.question;

            // Status text
            chapterStatus.textContent = `Chapter tag selected: ${config.label}`;

            // Gentle hint in practical box
            practicalBox.textContent =
                "When you click ‘Generate practical’, Sci-Guru will design an experiment for: " +
                config.experimentFocus;
        }

        chapterTagsContainer.addEventListener("click", (e) => {
            const btn = e.target.closest(".chapter-tag");
            if (!btn) return;
            const chapterId = btn.getAttribute("data-chapter-id");
            applyChapterTag(chapterId);
        });

        // ======== INIT ========
        checkBackendHealth();
    </script>
</body>
</html>
