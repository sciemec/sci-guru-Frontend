<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Sci-Guru AI Science Tutor</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="app-body">
  <!-- Top bar with logo + nav -->
  <header class="top-nav">
    <div class="nav-left">
      <img src="lec-logo.jpg" alt="LEC Biotec logo" class="nav-logo" />
      <div class="nav-title-block">
        <div class="nav-title">Sci-Guru AI Science Tutor</div>
        <div class="nav-subtitle">
          Zimbabwe's AI-powered tutor for the ZIMSEC / Heritage-Based curriculum
        </div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">Home</a>
      <a href="tutor.html" class="nav-link active">AI Tutor</a>
    </nav>
  </header>

  <!-- Main layout -->
  <main class="tutor-layout">
    <!-- ASK PANEL (LEFT) -->
    <section class="ask-panel">
      <h2>Ask Sci-Guru</h2>
      <p class="panel-description">
        Choose a form and topic (or tap a Form 1 chapter below), then ask your
        question in simple English.
      </p>

      <div class="form-group">
        <label for="formLevel">Form / Level</label>
        <select id="formLevel">
          <option value="Form 1" selected>Form 1</option>
          <option value="Form 2">Form 2</option>
          <option value="Form 3">Form 3</option>
          <option value="Form 4">Form 4</option>
        </select>
      </div>

      <div class="form-group">
        <label for="topic">
          Topic (Form 1 topics grouped + general)
        </label>
        <select id="topic">
          <option value="">
            -- Optional: choose a topic --
          </option>

          <optgroup label="General">
            <option value="General Science">General Science</option>
            <option value="Everyday Applications">Everyday applications of science</option>
          </optgroup>

          <optgroup label="Form 1 — Biology">
            <option value="Living things and characteristics of life">
              Living things and characteristics of life
            </option>
            <option value="Cells and simple microscopes">
              Cells and simple microscopes
            </option>
            <option value="Human body systems and hygiene">
              Human body systems and hygiene
            </option>
            <option value="Ecosystems and environment">
              Ecosystems and environment
            </option>
          </optgroup>

          <optgroup label="Form 1 — Physics">
            <option value="States of matter">
              States of matter
            </option>
            <option value="Mixtures and separation methods">
              Mixtures and separation methods
            </option>
            <option value="Density and flotation">
              Density and flotation
            </option>
            <option value="Electricity and magnetism">
              Electricity and magnetism
            </option>
          </optgroup>

          <optgroup label="Form 1 — Earth & Space">
            <option value="Earth, weather and climate">
              Earth, weather and climate
            </option>
            <option value="Solar system and beyond">
              Solar system and beyond
            </option>
          </optgroup>

          <optgroup label="Form 1 — Skills & Careers">
            <option value="Scientific skills and safety">
              Scientific skills and safety
            </option>
            <option value="Careers in science">
              Careers in science
            </option>
          </optgroup>
        </select>
      </div>

      <div class="form-group">
        <label for="question">Your question</label>
        <textarea
          id="question"
          rows="4"
          placeholder="Explain density using Zimbabwean examples..."
        ></textarea>
      </div>

      <!-- Buttons row -->
      <div class="button-row">
        <button id="askBtn" class="primary-btn">
          Ask Sci-Guru
        </button>
        <button id="quizBtn" class="secondary-btn">
          Generate quiz
        </button>
      </div>

      <div class="button-row">
        <button id="practicalBtn" class="outline-btn">
          Generate practical
        </button>
        <button
          id="openLabHubBtn"
          class="outline-btn"
          type="button"
        >
          Open virtual lab hub
        </button>
      </div>

      <!-- Save score -->
      <div class="save-score-panel">
        <label class="checkbox-inline">
          <input
            type="checkbox"
            id="saveScoreCheckbox"
            checked
          />
          I want to save my quiz result for this topic
        </label>

        <div class="score-input-row">
          <span>I scored</span>
          <input
            type="number"
            id="scoreInput"
            min="0"
            max="100"
            placeholder="e.g. 75"
          />
          <span>%</span>
          <button id="saveScoreBtn" class="small-primary-btn">
            Save topic score
          </button>
        </div>
      </div>

      <p id="statusText" class="status-text">
        Sci-Guru is ready. Backend: <span class="live-pill">LIVE</span>.
      </p>
    </section>

    <!-- RESULTS PANEL (RIGHT) -->
    <section class="results-panel">
      <div class="results-header">
        <div id="chapterStatus" class="chapter-status">
          No chapter tag selected (you can still ask any question).
        </div>
      </div>

      <div class="result-card">
        <h3>EXPLANATION</h3>
        <p id="explanationText">Sci-Guru will answer here...</p>
      </div>

      <div class="result-card">
        <h3>QUIZ</h3>
        <p id="quizText">Quiz will appear here...</p>
      </div>

      <div class="result-card">
        <h3>PRACTICAL</h3>
        <p id="practicalText">Practical experiment will appear here...</p>
      </div>

      <!-- CHAPTER STRIP -->
      <section class="chapters-section">
        <h4>
          Form 1 chapters ·
          <span id="chapterHint" class="chapter-hint">
            Tap a chapter to auto-fill topic, sample question &amp; experiment focus.
          </span>
        </h4>

        <div class="chapter-strip">
          <button class="chapter-tag" data-chapter="ch1">Ch. 1</button>
          <button class="chapter-tag" data-chapter="ch2">Ch. 2</button>
          <button class="chapter-tag" data-chapter="ch3">Ch. 3</button>
          <button class="chapter-tag" data-chapter="ch4">Ch. 4</button>
          <button class="chapter-tag" data-chapter="ch5">Ch. 5</button>
          <button class="chapter-tag" data-chapter="ch6">Ch. 6</button>
          <button class="chapter-tag" data-chapter="ch7">Ch. 7</button>
          <button class="chapter-tag" data-chapter="ch8">Ch. 8</button>
          <button class="chapter-tag" data-chapter="ch9">Ch. 9</button>
          <button class="chapter-tag" data-chapter="ch10">Ch. 10</button>
          <button class="chapter-tag" data-chapter="ch11">Ch. 11</button>
          <button class="chapter-tag" data-chapter="ch12">Ch. 12</button>
          <button class="chapter-tag" data-chapter="ch13">Ch. 13</button>
          <button class="chapter-tag" data-chapter="ch14">Ch. 14</button>
          <button class="chapter-tag" data-chapter="ch15">Ch. 15</button>
          <button class="chapter-tag" data-chapter="ch16">Ch. 16</button>
          <button class="chapter-tag" data-chapter="ch17">Ch. 17</button>
        </div>

        <p id="chapterFocus" class="chapter-focus-text">
          Experiment focus will appear here after you tap a chapter.
        </p>
      </section>
    </section>
  </main>

  <!-- SCRIPT -->
  <script>
    const API_BASE = "https://sci-guru-backend.onrender.com/api";

    const formLevelEl = document.getElementById("formLevel");
    const topicEl = document.getElementById("topic");
    const questionEl = document.getElementById("question");

    const askBtn = document.getElementById("askBtn");
    const quizBtn = document.getElementById("quizBtn");
    const practicalBtn = document.getElementById("practicalBtn");
    const openLabHubBtn = document.getElementById("openLabHubBtn");

    const explanationText = document.getElementById("explanationText");
    const quizText = document.getElementById("quizText");
    const practicalText = document.getElementById("practicalText");
    const statusText = document.getElementById("statusText");

    const saveScoreCheckbox = document.getElementById("saveScoreCheckbox");
    const scoreInput = document.getElementById("scoreInput");
    const saveScoreBtn = document.getElementById("saveScoreBtn");

    const chapterStatusEl = document.getElementById("chapterStatus");
    const chapterHintEl = document.getElementById("chapterHint");
    const chapterFocusEl = document.getElementById("chapterFocus");

    let selectedChapterKey = null;

    // --- FORM 1 CHAPTER DATA ---
    const chapterData = {
      ch1: {
        label: "Ch. 1 – Living things & characteristics of life",
        topic: "Living things and characteristics of life",
        sampleQuestion:
          "List the characteristics of living things and explain them using Zimbabwean farm examples.",
        practicalFocus:
          "Survey living and non-living things around the school yard and classify them."
      },
      ch2: {
        label: "Ch. 2 – Cells and simple microscopes",
        topic: "Cells and simple microscopes",
        sampleQuestion:
          "Explain what a cell is and why it is called the basic unit of life.",
        practicalFocus:
          "Observe onion cells or leaf peel under a simple microscope or magnifying lens."
      },
      ch3: {
        label: "Ch. 3 – Human body systems and hygiene",
        topic: "Human body systems and hygiene",
        sampleQuestion:
          "Describe the main human body systems and give examples of healthy habits.",
        practicalFocus:
          "Demonstrate proper hand-washing and design a hygiene poster for the class."
      },
      ch4: {
        label: "Ch. 4 – Ecosystems and environment",
        topic: "Ecosystems and environment",
        sampleQuestion:
          "Explain what an ecosystem is using a local river or field as an example.",
        practicalFocus:
          "Draw a simple food chain from a nearby ecosystem and identify producers, consumers and decomposers."
      },
      ch5: {
        label: "Ch. 5 – States of matter",
        topic: "States of matter",
        sampleQuestion:
          "Explain the three states of matter with local everyday examples.",
        practicalFocus:
          "Investigate how heating and cooling water changes its state (ice, liquid, steam)."
      },
      ch6: {
        label: "Ch. 6 – Mixtures & separation methods",
        topic: "Mixtures and separation methods",
        sampleQuestion:
          "What is a mixture? Explain and give examples from the kitchen.",
        practicalFocus:
          "Separate sand and salt, or beans and sand, using sieving, decanting or filtration."
      },
      ch7: {
        label: "Ch. 7 – Density and flotation",
        topic: "Density and flotation",
        sampleQuestion:
          "Explain density using an imbokodo and plastic bucket as examples.",
        practicalFocus:
          "Compare objects that float or sink in water and relate this to their density."
      },
      ch8: {
        label: "Ch. 8 – Electricity and magnetism",
        topic: "Electricity and magnetism",
        sampleQuestion:
          "Explain the difference between conductors and insulators.",
        practicalFocus:
          "Make a simple circuit with a battery and bulb and test local materials as conductors."
      },
      ch9: {
        label: "Ch. 9 – Earth, weather and climate",
        topic: "Earth, weather and climate",
        sampleQuestion:
          "Describe different types of weather found in Zimbabwe.",
        practicalFocus:
          "Keep a simple weather chart for one week, recording temperature and rainfall."
      },
      ch10: {
        label: "Ch. 10 – Solar system and beyond",
        topic: "Solar system and beyond",
        sampleQuestion:
          "Name the planets in our solar system in order from the Sun.",
        practicalFocus:
          "Create a scale model or drawing of the solar system using classroom materials."
      },
      ch11: {
        label: "Ch. 11 – Scientific skills and safety",
        topic: "Scientific skills and safety",
        sampleQuestion:
          "Explain why safety rules are important in a science laboratory.",
        practicalFocus:
          "Role-play correct and incorrect behaviour in a science lab and discuss the dangers."
      },
      ch12: {
        label: "Ch. 12 – Measurement in science",
        topic: "Scientific skills and safety",
        sampleQuestion:
          "Describe basic scientific measuring instruments and their units.",
        practicalFocus:
          "Measure mass, volume and length of classroom objects using simple equipment."
      },
      ch13: {
        label: "Ch. 13 – Scientific investigations",
        topic: "Scientific skills and safety",
        sampleQuestion:
          "Describe the main steps of a scientific investigation.",
        practicalFocus:
          "Plan a simple investigation, such as how sunlight affects plant growth."
      },
      ch14: {
        label: "Ch. 14 – Everyday applications of science",
        topic: "Everyday Applications",
        sampleQuestion:
          "Give examples of how science is used in Zimbabwean homes and industries.",
        practicalFocus:
          "Identify household technologies and explain the science ideas behind them."
      },
      ch15: {
        label: "Ch. 15 – End-of-form revision",
        topic: "",
        sampleQuestion:
          "Give me a mixed revision quiz for Form 1 Combined Science.",
        practicalFocus:
          "Create a revision mind map covering all Form 1 topics."
      },
      ch16: {
        label: "Ch. 16 – Project work",
        topic: "",
        sampleQuestion:
          "Suggest project ideas for Form 1 learners using local resources.",
        practicalFocus:
          "Design a small community-based science project, such as a clean water or waste-management project."
      },
      ch17: {
        label: "Ch. 17 – Careers in science",
        topic: "Careers in science",
        sampleQuestion:
          "List science-related careers that are important in Zimbabwe.",
        practicalFocus:
          "Prepare a career poster or interview project with a local science professional."
      }
    };

    function clearChapterHighlight() {
      document
        .querySelectorAll(".chapter-tag")
        .forEach((btn) => btn.classList.remove("active-chapter"));
    }

    // --- Chapter click handler (updates cards immediately) ---
    document.querySelectorAll(".chapter-tag").forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.chapter;
        const data = chapterData[key];

        selectedChapterKey = key;
        clearChapterHighlight();
        btn.classList.add("active-chapter");

        // Auto-select topic in dropdown if defined
        if (data.topic) {
          for (const opt of topicEl.options) {
            if (opt.value === data.topic) {
              opt.selected = true;
              break;
            }
          }
        } else {
          topicEl.value = "";
        }

        // Sample question
        questionEl.value = data.sampleQuestion;

        // Update result cards immediately
        explanationText.textContent =
          "Focus for " + data.label + ": " + data.sampleQuestion;

        practicalText.textContent =
          "Suggested practical / virtual lab focus:\n" +
          data.practicalFocus;

        // Header + hint text
        chapterStatusEl.textContent = "Chapter tag selected: " + data.label;
        chapterHintEl.textContent =
          "Experiment focus set. You can still edit the question before asking.";
        chapterFocusEl.textContent =
          "Experiment focus: " + data.practicalFocus +
          " · Now click Ask Sci-Guru, Generate quiz or Generate practical for AI-generated detail.";
      });
    });

    // --- API helper ---
    async function callApi(endpoint, body) {
      statusText.textContent = "Sci-Guru is thinking (loading)...";
      try {
        const res = await fetch(API_BASE + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          throw new Error("Server error: " + res.status);
        }

        const data = await res.json();
        statusText.textContent = "Sci-Guru is ready. Backend: LIVE.";
        return data;
      } catch (err) {
        console.error(err);
        statusText.textContent =
          "Error talking to server. Please check your connection.";
        return { error: err.message };
      }
    }

    // --- Button events ---
    askBtn.addEventListener("click", async () => {
      explanationText.textContent = "Sci-Guru is thinking (loading...)";
      const payload = {
        formLevel: formLevelEl.value,
        topic: topicEl.value,
        question: questionEl.value,
        chapterTag: selectedChapterKey
      };
      const data = await callApi("/ask", payload);
      if (!data.error && data.answer) {
        explanationText.textContent = data.answer;
      } else {
        explanationText.textContent =
          "Sorry, something went wrong while generating the explanation.";
      }
    });

    quizBtn.addEventListener("click", async () => {
      quizText.textContent = "Sci-Guru is generating a quiz...";
      const payload = {
        formLevel: formLevelEl.value,
        topic: topicEl.value,
        question: questionEl.value,
        chapterTag: selectedChapterKey
      };
      const data = await callApi("/quiz", payload);
      if (!data.error && data.quiz) {
        quizText.textContent = data.quiz;
      } else {
        quizText.textContent =
          "Sorry, something went wrong while generating the quiz.";
      }
    });

    practicalBtn.addEventListener("click", async () => {
      practicalText.textContent =
        "Sci-Guru is designing a practical or virtual lab...";
      const payload = {
        formLevel: formLevelEl.value,
        topic: topicEl.value,
        question: questionEl.value,
        chapterTag: selectedChapterKey
      };
      const data = await callApi("/practical", payload);
      if (!data.error && data.practical) {
        practicalText.textContent = data.practical;
      } else {
        practicalText.textContent =
          "Sorry, something went wrong while generating the practical.";
      }
    });

    // --- Virtual lab hub button ---
    openLabHubBtn.addEventListener("click", () => {
      // You can change this to whichever hub page you prefer
      window.location.href = "sim-form1-experiences.html";
    });

    // --- Save topic score (localStorage) ---
    const STORAGE_KEY = "sciGuruTopicScores";

    function loadScores() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }

    function saveScores(scores) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
    }

    saveScoreBtn.addEventListener("click", () => {
      if (!saveScoreCheckbox.checked) {
        alert("Tick the box if you want to save scores.");
        return;
      }
      const score = Number(scoreInput.value);
      if (Number.isNaN(score) || score < 0 || score > 100) {
        alert("Please enter a valid score between 0 and 100.");
        return;
      }
      const key =
        formLevelEl.value + " :: " + (topicEl.value || "No specific topic");
      const scores = loadScores();
      scores[key] = Math.max(scores[key] || 0, score);
      saveScores(scores);
      alert("Saved! Best score for this topic: " + scores[key] + "%");
    });
  </script>
</body>
</html>
