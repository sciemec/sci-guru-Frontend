<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sci-Guru Lab | Combustion</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f1b33;--text:#e8eefc;--muted:#a8b6d6;--border:rgba(255,255,255,0.08);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    header{padding:14px 16px;border-bottom:1px solid var(--border);background:rgba(15,27,51,0.75);backdrop-filter:blur(10px);}
    h1{margin:0;font-size:16px}
    p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.4}
    .wrap{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:460px 1fr;gap:14px;}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;}}
    .panel{background:rgba(15,27,51,0.82);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
    .ph{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:900;font-size:13px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .pb{padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    label{font-size:12px;color:var(--muted);min-width:200px}
    input,select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,0.03);color:var(--text);outline:none;
    }
    input[type="range"]{width:100%}
    .btn{
      display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,0.03);color:var(--text);text-decoration:none;cursor:pointer;font-size:13px;
    }
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    canvas{width:100%;height:560px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,0.03);}
    .hint{color:var(--muted);font-size:13px;line-height:1.45;margin:8px 0 0;}
    .good{color:#34d399}
    .bad{color:#fb7185}
  </style>
</head>
<body>
<header>
  <h1>Form 2 Chemistry Lab: Organic Chemistry — Combustion (Unit 12)</h1>
  <p>Compare complete vs incomplete combustion and see pollution (CO₂, CO, soot).</p>
</header>

<div class="wrap">
  <section class="panel">
    <div class="ph">
      <span>Controls</span>
      <span class="pill">Model simulation</span>
    </div>
    <div class="pb" id="controls"></div>
  </section>

  <section class="panel">
    <div class="ph">
      <span>Simulation View</span>
      <a class="btn" href="tutor.html">Back to Tutor</a>
    </div>
    <div class="pb">
      <canvas id="c" width="1100" height="860"></canvas>
      <p class="hint" id="note"></p>
    </div>
  </section>
</div>

<script>
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const controls = document.getElementById("controls");
  const note = document.getElementById("note");

  const S = {
    fuel: "methane",
    oxygen: 70,
    ventilation: 60,
    burnRate: 50,
    running: false
  };

  const fuelInfo = {
    methane: {name:"Methane (natural gas)", smokeBase:0.10, co2Base:0.75},
    petrol:  {name:"Petrol (hydrocarbon mix)", smokeBase:0.18, co2Base:0.80},
    charcoal:{name:"Charcoal (carbon-rich)", smokeBase:0.28, co2Base:0.85}
  };

  let particles = [];
  let lastT = performance.now();

  function clamp(a,b,x){ return Math.max(a, Math.min(b,x)); }

  function renderControls(){
    controls.innerHTML = `
      <div class="row"><span class="pill">Complete: plenty O₂ → CO₂ + H₂O</span><span class="pill">Incomplete: low O₂ → CO + soot</span></div>

      <div class="row">
        <label>Fuel type</label>
        <select id="fuel">
          <option value="methane" ${S.fuel==="methane"?"selected":""}>Methane</option>
          <option value="petrol" ${S.fuel==="petrol"?"selected":""}>Petrol</option>
          <option value="charcoal" ${S.fuel==="charcoal"?"selected":""}>Charcoal</option>
        </select>
      </div>

      <div class="row">
        <label>Oxygen level (air supply)</label>
        <input id="oxy" type="range" min="0" max="100" value="${S.oxygen}">
        <span class="pill">${S.oxygen}</span>
      </div>

      <div class="row">
        <label>Ventilation (smoke removal)</label>
        <input id="vent" type="range" min="0" max="100" value="${S.ventilation}">
        <span class="pill">${S.ventilation}</span>
      </div>

      <div class="row">
        <label>Burn rate</label>
        <input id="rate" type="range" min="0" max="100" value="${S.burnRate}">
        <span class="pill">${S.burnRate}</span>
      </div>

      <div class="row">
        <button class="btn" id="toggle">${S.running ? "Stop" : "Start"} burn</button>
        <button class="btn" id="reset">Reset</button>
      </div>

      <p class="hint">
        If oxygen is low, incomplete combustion produces <span class="bad">carbon monoxide (CO)</span> and soot (smoke).
        CO is poisonous.
      </p>
    `;

    document.getElementById("fuel").addEventListener("change", e=>{S.fuel=e.target.value; draw();});
    document.getElementById("oxy").addEventListener("input", e=>{S.oxygen=+e.target.value; renderControls(); draw();});
    document.getElementById("vent").addEventListener("input", e=>{S.ventilation=+e.target.value; renderControls(); draw();});
    document.getElementById("rate").addEventListener("input", e=>{S.burnRate=+e.target.value; renderControls(); draw();});

    document.getElementById("toggle").addEventListener("click", ()=>{
      S.running = !S.running;
      renderControls();
      lastT = performance.now();
      if (S.running) requestAnimationFrame(tick);
      draw();
    });

    document.getElementById("reset").addEventListener("click", ()=>{
      S.oxygen=70; S.ventilation=60; S.burnRate=50; S.fuel="methane"; S.running=false;
      particles=[];
      renderControls(); draw();
    });

    note.textContent = "Adjust oxygen and ventilation. Watch flame colour and smoke (soot) to compare complete vs incomplete combustion.";
  }

  function combustionQuality(){
    // quality is dominated by oxygen; ventilation reduces visible smoke but does NOT reduce CO production much (model)
    const oxy = S.oxygen/100;
    const q = clamp(0,1, oxy*1.25); // 0..1
    return q;
  }

  function emissionModel(){
    const q = combustionQuality();           // 1 = complete
    const f = fuelInfo[S.fuel];

    const rate = (S.burnRate/100);           // how much fuel is burning
    const co2 = rate * (f.co2Base * (0.55 + 0.45*q));         // more complete => more CO2 (instead of CO/soot)
    const co  = rate * ((1-q) * 0.85);       // incomplete => CO rises
    const sootRaw = rate * (f.smokeBase + (1-q)*0.55);        // incomplete => soot rises
    const vent = S.ventilation/100;
    const sootVisible = sootRaw * (1 - 0.75*vent);            // ventilation reduces visible smoke
    const flameBlue = q;                                      // more complete => bluer flame
    return {q, co2, co, sootRaw, sootVisible, flameBlue};
  }

  function spawnParticles(dt){
    const em = emissionModel();
    const n = Math.floor((S.burnRate/100) * 40 * dt);

    for(let i=0;i<n;i++){
      const isSoot = Math.random() < clamp(0,1, em.sootRaw*1.2);
      const isCO2 = !isSoot && (Math.random() < 0.5);
      particles.push({
        x: 550 + (Math.random()*60 - 30),
        y: 645 + (Math.random()*10),
        r: isSoot ? (2 + Math.random()*6) : (2 + Math.random()*5),
        vy: 40 + Math.random()*80,
        vx: (Math.random()*30 - 15),
        a: isSoot ? 0.22 : 0.14,
        type: isSoot ? "soot" : (isCO2 ? "co2" : "steam"),
        life: 0
      });
    }
  }

  function tick(t){
    if (!S.running) return;
    const dt = Math.min(0.05, (t-lastT)/1000);
    lastT = t;

    spawnParticles(dt);

    const vent = S.ventilation/100;
    particles.forEach(p=>{
      p.life += dt;
      p.y -= p.vy*dt;
      p.x += p.vx*dt;
      // ventilation pushes particles away faster
      p.a *= (1 - 0.6*vent*dt);
    });

    particles = particles.filter(p=>p.y>140 && p.a>0.03 && p.life<6);

    draw();
    requestAnimationFrame(tick);
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // frame
    ctx.strokeStyle="rgba(255,255,255,0.22)";
    ctx.lineWidth=3;
    ctx.strokeRect(50,50,canvas.width-100,canvas.height-100);

    const em = emissionModel();
    const fuelName = fuelInfo[S.fuel].name;

    // title
    ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.font="18px system-ui";
    ctx.fillText("Combustion Chamber", 70, 110);

    ctx.fillStyle="rgba(255,255,255,0.70)";
    ctx.font="13px system-ui";
    ctx.fillText(`Fuel: ${fuelName}`, 70, 140);
    ctx.fillText(`Combustion quality: ${(em.q*100).toFixed(0)}%`, 70, 160);

    // chamber
    const cx=160, cy=200, cw=540, ch=520;
    ctx.fillStyle="rgba(255,255,255,0.03)";
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=2;
    ctx.beginPath(); roundRect(cx,cy,cw,ch,24); ctx.fill(); ctx.stroke();

    // air inlet arrows
    ctx.strokeStyle="rgba(110,231,255,0.25)";
    ctx.lineWidth=3;
    for(let i=0;i<5;i++){
      const ay = 260 + i*80;
      ctx.beginPath();
      ctx.moveTo(cx-40, ay);
      ctx.lineTo(cx+20, ay);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(cx+20, ay);
      ctx.lineTo(cx+5, ay-10);
      ctx.lineTo(cx+5, ay+10);
      ctx.closePath();
      ctx.fillStyle="rgba(110,231,255,0.25)";
      ctx.fill();
    }

    ctx.fillStyle="rgba(255,255,255,0.65)";
    ctx.font="12px system-ui";
    ctx.fillText("O₂ (air) in", cx-48, cy+30);

    // burner
    ctx.fillStyle="rgba(255,255,255,0.06)";
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.beginPath(); roundRect(360, 650, 140, 40, 14); ctx.fill(); ctx.stroke();

    // flame: blue when complete, yellow/orange when incomplete
    const blue = em.flameBlue;
    const yellow = 1-blue;
    ctx.fillStyle = `rgba(${Math.round(255*yellow)},${Math.round(200*yellow + 120*blue)},${Math.round(255*blue)},0.35)`;
    ctx.beginPath();
    ctx.moveTo(430, 650);
    ctx.bezierCurveTo(410, 610, 420, 570, 430, 540);
    ctx.bezierCurveTo(440, 570, 450, 610, 430, 650);
    ctx.closePath();
    ctx.fill();

    // inner flame
    ctx.fillStyle = `rgba(${Math.round(120*yellow)},${Math.round(150*yellow + 180*blue)},${Math.round(255*blue)},0.35)`;
    ctx.beginPath();
    ctx.moveTo(430, 650);
    ctx.bezierCurveTo(420, 620, 426, 590, 430, 570);
    ctx.bezierCurveTo(434, 590, 440, 620, 430, 650);
    ctx.closePath();
    ctx.fill();

    // particles (smoke/steam/CO2 visual)
    particles.forEach(p=>{
      if (p.type==="soot") ctx.fillStyle = `rgba(255,255,255,${p.a})`;
      if (p.type==="co2")  ctx.fillStyle = `rgba(110,231,255,${p.a})`;
      if (p.type==="steam")ctx.fillStyle = `rgba(255,255,255,${p.a*0.7})`;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });

    // emissions dashboard
    const dx=740, dy=210, dw=320, dh=510;
    ctx.fillStyle="rgba(255,255,255,0.03)";
    ctx.strokeStyle="rgba(255,255,255,0.18)";
    ctx.lineWidth=2;
    ctx.beginPath(); roundRect(dx,dy,dw,dh,20); ctx.fill(); ctx.stroke();

    ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.font="16px system-ui";
    ctx.fillText("Emissions (Model)", dx+16, dy+34);

    function meter(y, title, val, max, col){
      const bx = dx+16, by = y, bw=dw-32, bh=20;
      ctx.fillStyle="rgba(255,255,255,0.06)";
      ctx.fillRect(bx,by,bw,bh);
      ctx.fillStyle=col;
      ctx.fillRect(bx,by,bw*clamp(0,1,val/max),bh);
      ctx.strokeStyle="rgba(255,255,255,0.18)";
      ctx.strokeRect(bx,by,bw,bh);

      ctx.fillStyle="rgba(255,255,255,0.75)";
      ctx.font="13px system-ui";
      ctx.fillText(`${title}: ${(val*100).toFixed(0)}%`, bx, by-8);
    }

    meter(dy+80,  "CO₂ (greenhouse gas)", em.co2, 1.0, "rgba(52,211,153,0.22)");
    meter(dy+160, "CO (poisonous)",       em.co,  1.0, "rgba(251,113,133,0.20)");
    meter(dy+240, "Soot/smoke (visible)", em.sootVisible, 1.0, "rgba(255,255,255,0.14)");

    // conclusion text
    const verdict = (em.q >= 0.75) ? "Complete combustion ✅ (blue flame, low soot/CO)" : "Incomplete combustion ⚠️ (yellow flame, higher CO + soot)";
    ctx.fillStyle = (em.q >= 0.75) ? "rgba(52,211,153,0.85)" : "rgba(251,113,133,0.85)";
    ctx.font="14px system-ui";
    ctx.fillText(verdict, dx+16, dy+330);

    ctx.fillStyle="rgba(255,255,255,0.65)";
    ctx.font="13px system-ui";
    ctx.fillText("Improve combustion by increasing oxygen/air supply.", dx+16, dy+360);
    ctx.fillText("Improve safety by good ventilation (removes smoke).", dx+16, dy+385);
    ctx.fillText("But ventilation does not 'remove' CO production if oxygen is low.", dx+16, dy+410);
  }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  renderControls();
  draw();
</script>
</body>
</html>
