<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Experiment: Bunsen Burner</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;padding:18px 0 30px;}
    .scene,.panel{border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.03);padding:14px;overflow:hidden;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .badge2{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-weight:900;}
    .small2{color:var(--muted);font-size:.93rem;line-height:1.45;}
    .btn2{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);font-weight:900;cursor:pointer;}
    .btn2.primary{border-color:rgba(47,107,255,.55);box-shadow:0 0 0 4px rgba(47,107,255,.12);}
    .toast{margin-top:12px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03);white-space:pre-wrap;}
    .controls{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px;}
    .control{padding:12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03);}
    .control label{display:flex;justify-content:space-between;gap:10px;align-items:center;font-weight:900;}
    .control input[type="range"]{width:100%;}
    .quizBox{margin-top:12px;padding:12px;border:1px dashed var(--border);border-radius:14px;background:rgba(255,255,255,.03);}
    .q{margin:10px 0 6px;font-weight:900;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-weight:900;}

    /* Lab drawing */
    .labWrap{display:grid;grid-template-columns:1fr;gap:12px;}
    .burnerArea{height:380px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.02);position:relative;overflow:hidden;}
    .bench{height:120px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.04);position:relative;overflow:hidden;}
    .bench:before{content:"";position:absolute;left:0;right:0;top:0;height:22px;background:rgba(255,255,255,.03);border-bottom:1px solid var(--border);}

    .burner{position:absolute;left:40%;bottom:44px;transform:translateX(-50%);width:180px;height:280px;}
    .base{position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:170px;height:40px;border-radius:20px;background:rgba(255,255,255,.05);border:1px solid var(--border);}
    .tube{position:absolute;left:50%;bottom:40px;transform:translateX(-50%);width:54px;height:165px;border-radius:18px;background:rgba(255,255,255,.04);border:1px solid var(--border);}
    .collar{position:absolute;left:50%;bottom:112px;transform:translateX(-50%);width:86px;height:44px;border-radius:18px;background:rgba(255,255,255,.04);border:1px solid var(--border);}
    .airHole{position:absolute;left:50%;bottom:126px;transform:translateX(-50%);height:10px;border-radius:6px;background:rgba(47,107,255,.25);border:1px solid rgba(47,107,255,.45);}
    .gasHose{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);width:240px;height:10px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid var(--border);}
    .tap{position:absolute;left:18px;bottom:18px;width:180px;height:72px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.04);padding:10px;}
    .tap b{display:block}
    .tap .small2{margin-top:2px}

    /* Match + spark */
    .match{position:absolute;left:16px;top:18px;width:180px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.04);padding:10px;}
    .spark{display:inline-block;margin-left:8px;opacity:0;transition:.2s;}
    .spark.on{opacity:1}

    /* Flame */
    .flame{position:absolute;left:50%;bottom:196px;transform:translateX(-50%);opacity:0;transition:.2s;filter:drop-shadow(0 8px 18px rgba(0,0,0,.22));}
    .flame.on{opacity:1;}
    .flameShape{position:absolute;left:50%;bottom:0;transform:translateX(-50%);border-radius:60% 60% 55% 55% / 70% 70% 30% 30%;}
    .flameInner{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);border-radius:60% 60% 55% 55% / 70% 70% 30% 30%;opacity:.85;}

    .type-safety .flameShape{background: rgba(255,190,90,.70);}
    .type-safety .flameInner{background: rgba(255,230,170,.70);}

    .type-roaring .flameShape{background: rgba(120,190,255,.55);}
    .type-roaring .flameInner{background: rgba(200,230,255,.70);}

    .type-yellow .flameShape{background: rgba(255,160,60,.75);}
    .type-yellow .flameInner{background: rgba(255,240,200,.70);}

    /* Blue flame hard-to-see effect */
    .hardToSee{outline:2px dashed rgba(255,255,255,.25); outline-offset:6px;}

    /* Beaker heating mini experiment */
    .beakerArea{position:absolute;left:68%;bottom:58px;transform:translateX(-50%);width:240px;height:300px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.03);padding:12px;}
    .beakerDraw{width:120px;height:160px;border-radius:18px;border:1px solid var(--border);background:rgba(255,255,255,.04);position:relative;overflow:hidden;margin-top:10px;}
    .water{position:absolute;left:0;right:0;bottom:0;height:58%;background:rgba(47,107,255,.18);}
    .thermo{margin-top:10px;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);}
    .bigTemp{font-size:1.4rem;font-weight:900;}
    .warn{margin-top:8px;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);white-space:pre-wrap;}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container row">
      <div class="brand">
        <img src="images/lec-logo.png" alt="LEC Biotec Logo">
        <div class="title">
          <b>Virtual Experiment: Bunsen Burner</b>
          <span>Safe lighting sequence ‚Ä¢ Blue flame visibility ‚Ä¢ Heat-a-beaker mini experiment</span>
        </div>
      </div>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="tutor.html">AI Tutor</a>
        <a class="active" href="sim-bunsen.html">Bunsen Lab</a>
        <a href="virtual-lab-hub.html">Virtual Lab Hub</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- SCENE -->
      <section class="card scene">
        <div class="row" style="justify-content:space-between;">
          <div>
            <span class="badge2" id="flameName">Flame: OFF</span>
            <span class="badge2" id="riskBadge">Risk: ‚Äî</span>
            <span class="badge2" id="scoreBadge">Score: 0</span>
          </div>
          <span class="badge2" id="taskBadge">Tasks: 0/4</span>
        </div>

        <div class="labWrap" style="margin-top:12px;">
          <div class="burnerArea">
            <div class="match">
              <b>Match Station</b>
              <div class="small2">Step: <span id="stepText">Not started</span><span class="spark" id="spark">‚ú®</span></div>
            </div>

            <div class="tap">
              <b>Gas Tap</b>
              <div class="small2">Use sliders on the right</div>
            </div>

            <!-- Beaker heating -->
            <div class="beakerArea">
              <b>Heat-a-beaker</b>
              <div class="small2">Start heating after burner is lit.</div>

              <div class="beakerDraw">
                <div class="water" id="waterLevel"></div>
              </div>

              <div class="thermo">
                <div class="small2">Temperature</div>
                <div class="bigTemp"><span id="tempVal">25</span> ¬∞C</div>
                <div class="small2">Time heating: <b id="timeVal">0</b> s</div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn2 primary" id="heatBtn">Start heating</button>
                <button class="btn2" id="stopHeatBtn">Stop</button>
              </div>

              <div class="warn" id="heatMsg">Tip: Roaring flame heats faster but is harder to see.</div>
            </div>

            <!-- Burner -->
            <div class="burner" aria-label="bunsen burner">
              <div class="flame" id="flame">
                <div class="flameShape" id="flameShape"></div>
                <div class="flameInner" id="flameInner"></div>
              </div>

              <div class="tube"></div>
              <div class="collar"></div>
              <div class="airHole" id="airHole"></div>
              <div class="base"></div>
              <div class="gasHose"></div>
            </div>
          </div>

          <div class="bench"></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <span class="pill">Correct order: Air CLOSED ‚Üí Match ON ‚Üí Gas LOW ‚Üí Match to burner ‚Üí Flame ‚Üí Open air (if needed)</span>
        </div>

        <div class="toast" id="sceneToast">
          Use the right panel to light safely, choose flame types, and complete tasks.
        </div>
      </section>

      <!-- PANEL -->
      <aside class="panel">
        <h2 style="margin:0 0 6px;">Controls</h2>
        <div class="small2">This simulator rewards correct lab procedure and warns about unsafe actions.</div>

        <div class="controls">
          <div class="control">
            <label>Gas flow <span class="badge2" id="gasVal">0%</span></label>
            <input id="gas" type="range" min="0" max="100" value="0" />
            <div class="small2">Keep gas LOW when lighting.</div>
          </div>

          <div class="control">
            <label>Air hole opening <span class="badge2" id="airVal">0%</span></label>
            <input id="air" type="range" min="0" max="100" value="0" />
            <div class="small2">Closed = yellow flame. Open = blue roaring flame.</div>
          </div>

          <div class="control">
            <label>Papers distance <span class="badge2" id="paperVal">Safe</span></label>
            <input id="papers" type="range" min="0" max="100" value="70" />
            <div class="small2">Move papers away to reduce fire risk.</div>
          </div>

          <div class="control">
            <label>PPE: Goggles <span class="badge2" id="ppeVal">OFF</span></label>
            <div class="row" style="margin-top:10px;">
              <button class="btn2 primary" id="ppeBtn">Toggle goggles</button>
              <button class="btn2" id="matchBtn">Strike match</button>
              <button class="btn2" id="bringMatchBtn">Bring match to burner</button>
            </div>
            <div class="small2" style="margin-top:8px;">You must wear goggles to earn full task marks.</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn2 primary" id="startTasksBtn">Start tasks</button>
          <button class="btn2" id="resetBtn">Reset</button>
          <a class="btn2" href="tutor.html">Back to Tutor</a>
        </div>

        <div class="quizBox" id="taskBox" style="display:none;">
          <div class="badge2" id="taskTitle">Task</div>
          <div class="q" id="taskText">‚Äî</div>
          <div class="small2" id="taskHint">‚Äî</div>
          <div class="toast" id="taskToast">Do the task, then press Check.</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn2 primary" id="checkBtn">Check</button>
            <button class="btn2" id="nextBtn">Next</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">

        <h3 style="margin:0 0 6px;">Safety reminders</h3>
        <div class="small2" style="white-space:pre-wrap;">
‚Ä¢ Wear goggles when heating.
‚Ä¢ Keep papers away from flame.
‚Ä¢ Light on LOW gas.
‚Ä¢ Use safety flame when waiting.
‚Ä¢ Turn off gas after use.
        </div>
      </aside>

    </div>
  </main>

  <script>
    // DOM
    const gas = document.getElementById("gas");
    const air = document.getElementById("air");
    const papers = document.getElementById("papers");

    const gasVal = document.getElementById("gasVal");
    const airVal = document.getElementById("airVal");
    const paperVal = document.getElementById("paperVal");

    const flame = document.getElementById("flame");
    const flameName = document.getElementById("flameName");
    const riskBadge = document.getElementById("riskBadge");
    const sceneToast = document.getElementById("sceneToast");
    const airHole = document.getElementById("airHole");

    const ppeBtn = document.getElementById("ppeBtn");
    const ppeVal = document.getElementById("ppeVal");
    const matchBtn = document.getElementById("matchBtn");
    const bringMatchBtn = document.getElementById("bringMatchBtn");
    const stepText = document.getElementById("stepText");
    const spark = document.getElementById("spark");

    const heatBtn = document.getElementById("heatBtn");
    const stopHeatBtn = document.getElementById("stopHeatBtn");
    const tempVal = document.getElementById("tempVal");
    const timeVal = document.getElementById("timeVal");
    const heatMsg = document.getElementById("heatMsg");

    const startTasksBtn = document.getElementById("startTasksBtn");
    const resetBtn = document.getElementById("resetBtn");
    const taskBox = document.getElementById("taskBox");
    const taskTitle = document.getElementById("taskTitle");
    const taskText = document.getElementById("taskText");
    const taskHint = document.getElementById("taskHint");
    const taskToast = document.getElementById("taskToast");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");

    const scoreBadge = document.getElementById("scoreBadge");
    const taskBadge = document.getElementById("taskBadge");

    // State
    let gogglesOn = false;
    let matchStruck = false;
    let matchAtBurner = false;
    let burnerLit = false;
    let score = 0;

    let heating = false;
    let t = 25;             // temp
    let heatSeconds = 0;
    let heatTimer = null;

    // Lighting steps (simple state machine)
    // Recommended sequence:
    // 1) goggles on
    // 2) air hole closed (<= 20)
    // 3) strike match
    // 4) gas low (15..40)
    // 5) bring match to burner
    // -> lights burner
    function paperSafety(p){
      if(p <= 35) return { label:"Danger", advice:"Papers are too close. Move them away from flame." };
      if(p <= 60) return { label:"Caution", advice:"Papers are somewhat close. Increase distance." };
      return { label:"Safe", advice:"Papers are far enough." };
    }

    function classifyFlame(g, a){
      if(!burnerLit || g === 0) return { type:"off", label:"OFF", risk:"‚Äî", advice:"Burner is off." };

      if(a <= 20){
        return { type:"yellow", label:"Yellow (luminous) flame", risk:"Medium (sooty)", advice:"Air hole closed ‚Üí yellow smoky flame (incomplete combustion). Not best for heating." };
      }
      if(a >= 60 && g >= 25){
        return { type:"roaring", label:"Blue (roaring) flame", risk:"High heat", advice:"Air hole open ‚Üí blue roaring flame. Hotter for heating but harder to see." };
      }
      return { type:"safety", label:"Blue (safety) flame", risk:"Low/Medium", advice:"Safety flame for waiting. Use roaring for heating." };
    }

    function setScore(delta, reason){
      score += delta;
      scoreBadge.textContent = "Score: " + score;
      if(reason) sceneToast.textContent = reason;
    }

    function updateUI(){
      const g = Number(gas.value);
      const a = Number(air.value);
      const p = Number(papers.value);

      gasVal.textContent = g + "%";
      airVal.textContent = a + "%";

      const ps = paperSafety(p);
      paperVal.textContent = ps.label;

      // air-hole indicator width
      airHole.style.width = (10 + Math.round(a/3)) + "px";

      // flame rendering
      flame.className = "flame";
      const f = classifyFlame(g, a);

      flameName.textContent = "Flame: " + (f.type === "off" ? "OFF" : f.label);
      riskBadge.textContent = "Risk: " + (f.type === "off" ? "‚Äî" : f.risk);

      if(f.type !== "off"){
        flame.classList.add("on", "type-" + f.type);

        // Hard to see effect on roaring flame
        flame.classList.toggle("hardToSee", f.type === "roaring");

        // Size depends on gas
        const h = 90 + Math.round(g * 1.1);
        const w = Math.max(90, Math.round(80 + g * 0.7));
        flame.style.height = h + "px";
        flame.style.width = w + "px";
        flame.querySelector(".flameShape").style.width = w + "px";
        flame.querySelector(".flameShape").style.height = h + "px";
        flame.querySelector(".flameInner").style.width = Math.round(w * 0.46) + "px";
        flame.querySelector(".flameInner").style.height = Math.round(h * 0.55) + "px";
      }else{
        flame.classList.remove("on","hardToSee");
      }

      // Step text
      let step = "Put on goggles ‚Üí close air hole ‚Üí strike match ‚Üí gas LOW ‚Üí bring match to burner";
      if(gogglesOn) step = "Close air hole ‚Üí strike match ‚Üí gas LOW ‚Üí bring match to burner";
      if(gogglesOn && a <= 20) step = "Strike match ‚Üí gas LOW ‚Üí bring match to burner";
      if(matchStruck) step = "Gas LOW ‚Üí bring match to burner";
      if(matchStruck && g >= 15 && g <= 40) step = "Bring match to burner";
      if(burnerLit) step = "Lit ‚úÖ Adjust air to safety/roaring flame. Turn off gas when finished.";
      stepText.textContent = step;

      // Warnings
      let warn = f.advice + "\n" + ps.advice;
      if(f.type === "roaring") warn += "\n‚ö†Ô∏è Blue flame can be hard to see. Keep clear and be careful.";
      if(ps.label === "Danger" && f.type !== "off") warn += "\n‚ö†Ô∏è Fire risk: papers too close!";
      sceneToast.textContent = warn;
    }

    // PPE
    ppeBtn.onclick = ()=>{
      gogglesOn = !gogglesOn;
      ppeVal.textContent = gogglesOn ? "ON" : "OFF";
      setScore(gogglesOn ? 2 : -1, gogglesOn ? "‚úÖ Goggles ON. Good lab practice." : "‚ö†Ô∏è Goggles OFF. Not safe for heating.");
      updateUI();
    };

    // Strike match
    matchBtn.onclick = ()=>{
      if(!gogglesOn){
        setScore(-2, "‚ùå Unsafe: Strike match without goggles (training penalty). Turn goggles ON first.");
        return;
      }
      const a = Number(air.value);
      if(a > 30){
        setScore(-1, "‚ö†Ô∏è Recommended: close air hole BEFORE lighting (training). Set air ‚â§ 20% then try again.");
        // still allow, but penalize
      }
      matchStruck = true;
      spark.classList.add("on");
      setTimeout(()=>spark.classList.remove("on"), 600);
      setScore(2, "‚úÖ Match struck. Now set GAS LOW (15‚Äì40%) then bring match to burner.");
      updateUI();
    };

    // Bring match to burner
    bringMatchBtn.onclick = ()=>{
      const g = Number(gas.value);
      const a = Number(air.value);

      if(!matchStruck){
        setScore(-1, "‚ùå You need to strike the match first.");
        return;
      }
      if(!gogglesOn){
        setScore(-2, "‚ùå Unsafe: no goggles. Turn goggles ON.");
        return;
      }
      if(g < 15){
        setScore(-1, "‚ùå Gas is too low/off. Set gas to LOW (15‚Äì40%) then bring match.");
        return;
      }
      if(g > 60){
        setScore(-3, "‚ùå Dangerous: gas too high while lighting. Reduce gas to LOW (15‚Äì40%) before lighting.");
        return;
      }

      matchAtBurner = true;

      // If gas is set and match is there, light burner
      burnerLit = true;
      setScore(3, "üî• Burner lit! Adjust air hole for safety flame or roaring flame.");
      updateUI();

      // encourage correct next step
      if(a <= 20){
        setScore(1, "‚úÖ Good: air hole was closed while lighting (safe training). Now open air for blue flame.");
      }
    };

    // Gas/air/papers changes
    function unsafeGasWithoutMatch(){
      const g = Number(gas.value);
      if(g >= 35 && !matchStruck && !burnerLit){
        setScore(-2, "‚ö†Ô∏è Unsafe: turning gas up before striking match. In real labs this can cause a gas build-up.");
      }
    }

    gas.addEventListener("input", ()=>{
      // Turning gas to 0 turns off burner and heating
      if(Number(gas.value) === 0){
        burnerLit = false;
        matchStruck = false;
        matchAtBurner = false;
        stopHeating();
        setScore(1, "‚úÖ Gas OFF. Good habit after use.");
      }
      unsafeGasWithoutMatch();
      updateUI();
    });

    air.addEventListener("input", updateUI);
    papers.addEventListener("input", updateUI);

    // Heating model
    function heatRate(){
      const g = Number(gas.value);
      const a = Number(air.value);
      const f = classifyFlame(g,a);

      if(!burnerLit || g === 0) return 0;

      // Base rates (¬∞C per second) tuned for demo
      if(f.type === "yellow") return 0.10 + (g/100)*0.12;   // slower + sooty
      if(f.type === "safety") return 0.14 + (g/100)*0.14;   // medium
      if(f.type === "roaring") return 0.20 + (g/100)*0.20;  // fastest
      return 0.0;
    }

    function startHeating(){
      const p = Number(papers.value);
      const ps = paperSafety(p);
      if(ps.label === "Danger"){
        setScore(-2, "‚ùå Fire risk: papers too close. Move papers away before heating.");
        return;
      }
      if(!burnerLit){
        setScore(-1, "‚ùå Burner is not lit. Light the burner first.");
        return;
      }
      if(!gogglesOn){
        setScore(-2, "‚ùå Goggles OFF. Turn goggles ON before heating.");
        return;
      }
      if(heating) return;

      heating = true;
      heatMsg.textContent = "Heating started ‚úÖ Watch temperature rise. Stop near your target.";
      heatTimer = setInterval(()=>{
        const rate = heatRate();
        if(rate <= 0){ stopHeating(); return; }
        t = Math.min(100, t + rate);
        heatSeconds += 1;

        tempVal.textContent = Math.round(t);
        timeVal.textContent = heatSeconds;

        if(t >= 98){
          heatMsg.textContent = "Near boiling! Stop heating to avoid spills/splashes.";
        }
      }, 1000);

      setScore(1, "‚úÖ Heating started safely.");
    }

    function stopHeating(){
      if(heatTimer) clearInterval(heatTimer);
      heatTimer = null;
      heating = false;
    }

    heatBtn.onclick = startHeating;
    stopHeatBtn.onclick = ()=>{
      stopHeating();
      setScore(1, "Heating stopped.");
      heatMsg.textContent = "Heating stopped. If done, turn gas OFF.";
    };

    // Tasks
    const tasks = [
      {
        title:"Task 1: Light safely (correct order)",
        text:"Light the burner safely using the correct sequence.",
        hint:"Goggles ON ‚Üí air closed (‚â§20) ‚Üí strike match ‚Üí gas LOW (15‚Äì40) ‚Üí bring match.",
        check: ()=> gogglesOn && burnerLit && matchStruck && Number(air.value) <= 25 && Number(gas.value) >= 15 && Number(gas.value) <= 40
      },
      {
        title:"Task 2: Set a SAFETY flame",
        text:"Set a safe waiting flame (not roaring).",
        hint:"Burner lit + air 25‚Äì55 + gas 15‚Äì55 + papers safe.",
        check: ()=>{
          const g=Number(gas.value), a=Number(air.value), p=Number(papers.value);
          const ps=paperSafety(p);
          return burnerLit && g>=15 && g<=55 && a>=25 && a<=55 && ps.label==="Safe";
        }
      },
      {
        title:"Task 3: Set a ROARING heating flame",
        text:"Set a hot flame for heating (roaring).",
        hint:"Air ‚â• 60 + gas ‚â• 30. Papers safe. Goggles on.",
        check: ()=>{
          const g=Number(gas.value), a=Number(air.value), p=Number(papers.value);
          const ps=paperSafety(p);
          return burnerLit && gogglesOn && g>=30 && a>=60 && ps.label==="Safe";
        }
      },
      {
        title:"Task 4: Heat water to ~60¬∞C then stop",
        text:"Start heating and stop when the beaker is about 60¬∞C (¬±3).",
        hint:"Light burner first. Use roaring flame for faster heating. Stop between 57‚Äì63¬∞C.",
        check: ()=>{
          const temp = Math.round(t);
          return temp >= 57 && temp <= 63 && !heating && heatSeconds > 0;
        }
      }
    ];

    let tasksStarted = false;
    let current = 0;
    let passed = [false,false,false,false];

    function updateTaskBadge(){
      const done = passed.filter(Boolean).length;
      taskBadge.textContent = `Tasks: ${done}/4`;
    }

    function showTask(){
      const tt = tasks[current];
      taskTitle.textContent = tt.title;
      taskText.textContent = tt.text;
      taskHint.textContent = tt.hint;
      taskToast.textContent = "Do the task, then press Check.";
      updateTaskBadge();
    }

    startTasksBtn.onclick = ()=>{
      tasksStarted = true;
      taskBox.style.display = "block";
      current = 0;
      showTask();
      setScore(1, "Tasks started ‚úÖ Complete all 4 for full score.");
    };

    checkBtn.onclick = ()=>{
      if(!tasksStarted) return;
      const ok = tasks[current].check();
      if(ok){
        if(!passed[current]) setScore(3, "‚úÖ Task completed (+3).");
        passed[current] = true;
        taskToast.textContent = "‚úÖ Correct! Task completed.";
      }else{
        taskToast.textContent = "‚ùå Not yet. Follow the hint and try again.";
        setScore(-1, "Try again (training penalty).");
      }
      updateTaskBadge();
    };

    nextBtn.onclick = ()=>{
      if(!tasksStarted) return;
      current = (current + 1) % tasks.length;
      showTask();
    };

    // Reset
    resetBtn.onclick = ()=>{
      gogglesOn = false;
      matchStruck = false;
      matchAtBurner = false;
      burnerLit = false;
      score = 0;
      scoreBadge.textContent = "Score: 0";

      gas.value = 0;
      air.value = 0;
      papers.value = 70;

      ppeVal.textContent = "OFF";
      spark.classList.remove("on");

      stopHeating();
      t = 25;
      heatSeconds = 0;
      tempVal.textContent = "25";
      timeVal.textContent = "0";
      heatMsg.textContent = "Tip: Roaring flame heats faster but is harder to see.";

      tasksStarted = false;
      current = 0;
      passed = [false,false,false,false];
      taskBox.style.display = "none";
      updateTaskBadge();

      updateUI();
      sceneToast.textContent = "Reset done. Now try lighting safely again.";
    };

    // Init
    updateTaskBadge();
    updateUI();
  </script>
</body>
              </html>
