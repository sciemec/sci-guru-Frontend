<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Virtual Experiment: Microscope</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;padding:18px 0 30px;}
    .card2{border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.03);padding:14px;}
    .small2{color:var(--muted);font-size:.93rem;line-height:1.45;}
    .badge2{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-weight:900;}
    .btn2{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);font-weight:900;cursor:pointer;}
    .btn2.primary{border-color:rgba(47,107,255,.55);box-shadow:0 0 0 4px rgba(47,107,255,.12);}
    .controls{display:grid;gap:10px;margin-top:12px;}
    .control{padding:12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03);}
    .control label{display:flex;justify-content:space-between;gap:10px;align-items:center;font-weight:900;}
    .control input[type="range"]{width:100%;}
    .view{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;}
    .lens{width:320px;max-width:100%;aspect-ratio:1/1;border-radius:50%;
      border:1px solid var(--border);background:rgba(255,255,255,.03);
      overflow:hidden; position:relative;}
    canvas{position:absolute;inset:0;width:100%;height:100%;}
    .overlay{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;padding:10px;}
    .toast{margin-top:12px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03);white-space:pre-wrap;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-weight:900;}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
<header class="topbar">
  <div class="container row">
    <div class="brand">
      <img src="images/lec-logo.png" alt="LEC Biotec Logo">
      <div class="title">
        <b>Virtual Experiment: Microscope</b>
        <span>Focus • objective lens • total magnification</span>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="tutor.html">AI Tutor</a>
      <a class="active" href="sim-microscope.html">Microscope Lab</a>
      <a href="sim-cells-hub.html">Topic 2 Hub</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid">
    <!-- VIEW -->
    <section class="card2">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
        <div>
          <span class="pill">Specimen: Onion epidermis (demo)</span>
          <div class="small2">Goal: get a clear image using coarse then fine focus.</div>
        </div>
        <div>
          <span class="badge2" id="score">Score: 0</span>
          <span class="badge2" id="status">Not focused</span>
        </div>
      </div>

      <div class="view" style="margin-top:12px;">
        <div class="lens">
          <canvas id="cv"></canvas>
          <div class="overlay">
            <span class="badge2" id="magTag">Objective: 4× | Eyepiece: 10×</span>
          </div>
        </div>

        <div style="min-width:250px;flex:1;">
          <div class="card2" style="box-shadow:none;">
            <b>How to focus (correct method)</b>
            <div class="small2" style="margin-top:6px;">
              1) Start on low power (4×)<br>
              2) Use <b>coarse focus</b> to get close<br>
              3) Use <b>fine focus</b> to sharpen<br>
              4) Increase magnification, then only fine focus
            </div>
          </div>

          <div class="toast" id="toast">Tip: If you jump to 40× while blurred, you will struggle to focus.</div>
        </div>
      </div>
    </section>

    <!-- CONTROLS -->
    <aside class="card2">
      <h2 style="margin:0 0 6px;">Controls</h2>
      <div class="small2">Use the controls and complete tasks. (This sim rewards correct microscope procedure.)</div>

      <div class="controls">
        <div class="control">
          <label>Objective lens <span class="badge2" id="objVal">4×</span></label>
          <select id="objective" class="input">
            <option value="4" selected>4× (low power)</option>
            <option value="10">10× (medium)</option>
            <option value="40">40× (high power)</option>
          </select>
          <div class="small2">Eyepiece is fixed at 10×.</div>
        </div>

        <div class="control">
          <label>Coarse focus <span class="badge2" id="coarseVal">50</span></label>
          <input id="coarse" type="range" min="0" max="100" value="50">
          <div class="small2">Use coarse focus mainly on low power.</div>
        </div>

        <div class="control">
          <label>Fine focus <span class="badge2" id="fineVal">50</span></label>
          <input id="fine" type="range" min="0" max="100" value="50">
          <div class="small2">Use fine focus to sharpen.</div>
        </div>

        <div class="control">
          <label>Brightness <span class="badge2" id="brightVal">60%</span></label>
          <input id="bright" type="range" min="20" max="100" value="60">
          <div class="small2">Adjust light for better viewing.</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn2 primary" id="startTasks">Start tasks</button>
        <button class="btn2" id="reset">Reset</button>
        <a class="btn2" href="sim-cells-hub.html">Back to Topic 2 Hub</a>
      </div>

      <div class="card2" style="margin-top:12px;box-shadow:none;">
        <b>Total magnification</b>
        <div class="small2" style="margin-top:6px;">
          Total magnification = <b>eyepiece</b> × <b>objective</b><br>
          Eyepiece = 10×
        </div>
        <div class="toast" id="magToast">Example: 10× × 4× = 40×</div>
      </div>

      <div class="card2" id="taskBox" style="margin-top:12px;display:none;box-shadow:none;">
        <span class="badge2" id="taskTitle">Task</span>
        <div class="small2" id="taskText" style="margin-top:6px;">—</div>
        <div class="toast" id="taskToast">Do the task, then click Check.</div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn2 primary" id="check">Check</button>
          <button class="btn2" id="next">Next</button>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
  // Canvas specimen drawing
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  function resize(){
    const r = cv.getBoundingClientRect();
    cv.width = Math.round(r.width * devicePixelRatio);
    cv.height = Math.round(r.height * devicePixelRatio);
    draw();
  }
  window.addEventListener("resize", resize);

  // Controls
  const objective = document.getElementById("objective");
  const coarse = document.getElementById("coarse");
  const fine = document.getElementById("fine");
  const bright = document.getElementById("bright");

  const objVal = document.getElementById("objVal");
  const coarseVal = document.getElementById("coarseVal");
  const fineVal = document.getElementById("fineVal");
  const brightVal = document.getElementById("brightVal");

  const scoreEl = document.getElementById("score");
  const statusEl = document.getElementById("status");
  const toast = document.getElementById("toast");
  const magTag = document.getElementById("magTag");
  const magToast = document.getElementById("magToast");

  let score = 0;

  // Focus model
  // True focus point depends on objective.
  // At higher magnification, narrower focus tolerance.
  function focusTarget(obj){
    if(obj === 4) return {c:55, f:52, tol:12};
    if(obj === 10) return {c:58, f:50, tol:8};
    return {c:60, f:48, tol:5}; // 40x
  }

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function focusQuality(){
    const obj = Number(objective.value);
    const t = focusTarget(obj);
    const dc = Math.abs(Number(coarse.value) - t.c);
    const df = Math.abs(Number(fine.value) - t.f);
    // Coarse error weighted more at high power
    const wC = obj === 40 ? 1.6 : (obj === 10 ? 1.2 : 1.0);
    const err = (dc * wC) + df;
    const q = clamp(1 - (err / (t.tol*3)), 0, 1);
    return {q, err, tol: t.tol};
  }

  function draw(){
    const obj = Number(objective.value);
    const b = Number(bright.value) / 100;

    const {q} = focusQuality();
    const blur = (1 - q) * (obj === 40 ? 10 : (obj === 10 ? 7 : 5));

    // Background
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.save();
    ctx.scale(devicePixelRatio, devicePixelRatio);

    // Lens dark rim
    const w = cv.width / devicePixelRatio;
    const h = cv.height / devicePixelRatio;
    ctx.fillStyle = "rgba(0,0,0,.25)";
    ctx.fillRect(0,0,w,h);

    // Specimen area
    const pad = 18;
    ctx.fillStyle = `rgba(255,255,255,${0.10 + 0.40*b})`;
    ctx.fillRect(pad,pad,w-pad*2,h-pad*2);

    // Draw "cells" (rectangles)
    ctx.save();
    ctx.beginPath();
    ctx.rect(pad,pad,w-pad*2,h-pad*2);
    ctx.clip();

    // Scale of cells changes with objective
    const cellSize = obj === 4 ? 42 : (obj === 10 ? 70 : 110);
    const offsetX = (Number(coarse.value)-50) * (obj===40?1.2:(obj===10?0.9:0.6));
    const offsetY = (Number(fine.value)-50) * (obj===40?1.1:(obj===10?0.8:0.5));

    // Simple blur simulation: draw multiple transparent layers when blurred
    const layers = Math.max(1, Math.round(1 + blur/3));
    for(let L=0; L<layers; L++){
      const alpha = 1 / layers;
      ctx.strokeStyle = `rgba(40,40,40,${0.35*alpha})`;
      ctx.lineWidth = 2;

      for(let y = pad-200; y < h; y += cellSize){
        for(let x = pad-200; x < w; x += cellSize){
          const jx = x + offsetX + (L - layers/2) * (blur*0.6);
          const jy = y + offsetY + (L - layers/2) * (blur*0.6);
          ctx.strokeRect(jx, jy, cellSize-6, cellSize-6);
          // nucleus dot
          ctx.fillStyle = `rgba(20,20,20,${0.25*alpha})`;
          ctx.beginPath();
          ctx.arc(jx + (cellSize/2), jy + (cellSize/2), Math.max(2, cellSize/12), 0, Math.PI*2);
          ctx.fill();
        }
      }
    }

    ctx.restore();

    // Crosshair
    ctx.strokeStyle = "rgba(255,255,255,.35)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(w/2, pad); ctx.lineTo(w/2, h-pad);
    ctx.moveTo(pad, h/2); ctx.lineTo(w-pad, h/2);
    ctx.stroke();

    // Vignette
    const grad = ctx.createRadialGradient(w/2,h/2, w*0.1, w/2,h/2, w*0.55);
    grad.addColorStop(0, "rgba(0,0,0,0)");
    grad.addColorStop(1, "rgba(0,0,0,.55)");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,w,h);

    ctx.restore();

    // UI status
    const totalMag = 10 * obj;
    magTag.textContent = `Objective: ${obj}× | Eyepiece: 10×`;
    magToast.textContent = `Total magnification = 10× × ${obj}× = ${totalMag}×`;

    if(focusQuality().q >= 0.90){
      statusEl.textContent = "Focused ✅";
    }else{
      statusEl.textContent = "Blurred";
    }
  }

  function updateLabels(){
    objVal.textContent = objective.value + "×";
    coarseVal.textContent = coarse.value;
    fineVal.textContent = fine.value;
    brightVal.textContent = bright.value + "%";
    draw();
  }

  objective.addEventListener("change", ()=>{
    const obj = Number(objective.value);
    // penalty if switching to 40x while still very blurred
    if(obj === 40 && focusQuality().q < 0.6){
      score -= 1;
      scoreEl.textContent = "Score: " + score;
      toast.textContent = "⚠️ You switched to 40× while very blurred. Better: focus at low power first.";
    }
    updateLabels();
  });
  coarse.addEventListener("input", updateLabels);
  fine.addEventListener("input", updateLabels);
  bright.addEventListener("input", updateLabels);

  // Tasks
  const taskBox = document.getElementById("taskBox");
  const startTasks = document.getElementById("startTasks");
  const taskTitle = document.getElementById("taskTitle");
  const taskText = document.getElementById("taskText");
  const taskToast = document.getElementById("taskToast");
  const check = document.getElementById("check");
  const next = document.getElementById("next");
  const reset = document.getElementById("reset");

  const tasks = [
    {
      title:"Task 1",
      text:"Focus clearly on low power (4×).",
      check:()=> Number(objective.value)===4 && focusQuality().q>=0.90
    },
    {
      title:"Task 2",
      text:"Switch to 10× and focus clearly using fine focus (keep it sharp).",
      check:()=> Number(objective.value)===10 && focusQuality().q>=0.90
    },
    {
      title:"Task 3",
      text:"Compute total magnification at 40× objective.",
      check:()=> Number(objective.value)===40
    },
    {
      title:"Task 4",
      text:"At 40×, get the image as clear as possible.",
      check:()=> Number(objective.value)===40 && focusQuality().q>=0.85
    }
  ];
  let started=false, idx=0, passed=[false,false,false,false];

  function showTask(){
    const t = tasks[idx];
    taskTitle.textContent = t.title;
    taskText.textContent = t.text;
    taskToast.textContent = "Do the task, then click Check.";
  }

  startTasks.onclick = ()=>{
    started = true;
    taskBox.style.display = "block";
    idx = 0;
    passed = [false,false,false,false];
    showTask();
    toast.textContent = "Tasks started ✅ Focus correctly to earn points.";
  };

  check.onclick = ()=>{
    if(!started) return;
    const ok = tasks[idx].check();
    if(ok){
      if(!passed[idx]) score += 3;
      passed[idx] = true;
      scoreEl.textContent = "Score: " + score;

      if(idx === 2){
        const totalMag = 10 * Number(objective.value);
        taskToast.textContent = `✅ Correct. Total magnification = ${totalMag}×. Now focus at 40×.`;
      }else{
        taskToast.textContent = "✅ Task completed!";
      }
    }else{
      score -= 1;
      scoreEl.textContent = "Score: " + score;
      taskToast.textContent = "❌ Not yet. Follow correct microscope procedure and try again.";
    }
  };

  next.onclick = ()=>{
    if(!started) return;
    idx = (idx + 1) % tasks.length;
    showTask();
  };

  reset.onclick = ()=>{
    objective.value = "4";
    coarse.value = "50";
    fine.value = "50";
    bright.value = "60";
    score = 0;
    scoreEl.textContent = "Score: 0";
    started=false;
    taskBox.style.display="none";
    toast.textContent = "Reset done. Start on low power and focus again.";
    updateLabels();
  };

  resize();
  updateLabels();
</script>
</body>
</html>
