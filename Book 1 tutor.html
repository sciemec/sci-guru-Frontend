<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sci-Guru AI Tutor</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    .layout{display:grid;grid-template-columns:320px 1fr;gap:14px;padding:18px 0 30px;}
    .chapters{position:sticky;top:76px;height:calc(100vh - 96px);overflow:auto;padding-right:6px;}
    .chapterBtn{width:100%;text-align:left;padding:11px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);color:var(--text);cursor:pointer;margin-bottom:10px;font-weight:800;
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .chapterBtn small{display:block;color:var(--muted);font-weight:600;margin-top:4px;line-height:1.25;}
    .chapterBtn .termTag{display:inline-block;font-weight:800;font-size:.78rem;padding:3px 8px;border-radius:999px;
      border:1px solid var(--border);background:rgba(255,255,255,.03);margin-top:6px;}
    .chapterBtn.active{border-color:rgba(47,107,255,.55);box-shadow:0 0 0 4px rgba(47,107,255,.12);}
    .check{font-size:1rem;opacity:.9;margin-top:2px;}
    .mainArea{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .pillRow{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 12px;}
    .pill{padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04);
      color:var(--text);font-weight:900;cursor:pointer;user-select:none;}
    .pill.active{border-color:rgba(47,107,255,.55);box-shadow:0 0 0 4px rgba(47,107,255,.12);}
    .progressWrap{margin:8px 0 14px;padding:12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03);}
    .bar{height:10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);overflow:hidden;}
    .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));}
    .mutedLine{color:var(--muted);font-size:.92rem;line-height:1.4;}
    .hintBox{margin-top:10px;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:rgba(255,255,255,.03);}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.chapters{position:relative;top:auto;height:auto}.mainArea{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container row">
      <div class="brand">
        <img src="images/lec-logo.png" alt="LEC Biotec Logo">
        <div class="title">
          <b>Sci-Guru AI Science Tutor</b>
          <span>Aligned to Step Ahead Combined Science Book 1 (Form 1)</span>
        </div>
      </div>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a class="active" href="tutor.html">AI Tutor</a>
        <a href="library.html">My Library</a>
        <a href="virtual-lab-hub.html">Virtual Lab Hub</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="layout">

      <!-- LEFT -->
      <aside class="card chapters">
        <h2 style="margin-bottom:6px;">Book 1 Topics</h2>
        <p class="small" style="margin-bottom:10px;">Progress is saved on your device.</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <span class="badge" id="apiStatus">API: checking...</span>
          <span class="badge">Render Free may sleep</span>
        </div>

        <div class="progressWrap">
          <div class="small" id="progressText">Progress: 0/19</div>
          <div class="bar" style="margin-top:8px;"><div id="barFill"></div></div>
        </div>

        <div id="chapterList"></div>
      </aside>

      <!-- RIGHT -->
      <section class="mainArea">

        <!-- ASK -->
        <section class="card">
          <h2>Learning Tools</h2>
          <p class="small">Notes + Exams are generated by AI. Virtual Experiments open simulations.</p>

          <div class="pillRow" id="contentPills">
            <div class="pill active" data-mode="Notes">Notes</div>
            <div class="pill" data-mode="Worked Examples">Virtual Experiments</div>
            <div class="pill" data-mode="Past Exam Questions">Past Exam Questions</div>
            <div class="pill" data-mode="Marking Scheme">Marking Scheme</div>
          </div>

          <label class="small" for="form">Form / Level</label>
          <select id="form" class="input">
            <option value="Form 1" selected>Form 1</option>
            <option value="Form 2">Form 2</option>
            <option value="Form 3">Form 3</option>
            <option value="Form 4">Form 4</option>
          </select>

          <div style="height:10px"></div>

          <label class="small" for="chapter">Selected Topic</label>
          <input id="chapter" class="input" readonly />

          <div style="height:10px"></div>

          <label class="small" for="topic">Subtopic</label>
          <select id="topic" class="input"></select>

          <div style="height:10px"></div>

          <label class="small" for="q">Extra instruction (optional)</label>
          <textarea id="q" class="input" placeholder="e.g. Use Zimbabwe examples, keep it short, add 5 revision questions..."></textarea>

          <div style="height:10px"></div>

          <div class="actions">
            <button class="btn primary" id="genBtn">Generate</button>
            <button class="btn" id="quizBtn">Quick Quiz</button>
            <button class="btn" id="pracBtn">Practical</button>
            <a class="btn" id="openLabBtn" href="virtual-lab-hub.html">Open related lab</a>
          </div>

          <div class="hintBox" id="modeHint">
            Tip: Choose <b>Virtual Experiments</b> to run an interactive simulation instead of text worked examples.
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="toggleDoneBtn">Mark topic as done</button>
            <a class="btn" href="library.html">Open My Library</a>
          </div>

          <div class="mutedLine" style="margin-top:12px;">
            If first request is slow: Render is waking up. Try again after ~30–60 seconds.
          </div>
        </section>

        <!-- OUTPUT -->
        <section class="card">
          <h2>Output</h2>
          <p class="small">Text output appears here (Virtual Experiments open simulation pages).</p>

          <div id="out" class="card" style="background:rgba(255,255,255,.03); border-radius:12px; border:1px solid var(--border); box-shadow:none;">
            <p class="small" style="margin:0">No output yet.</p>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="saveBtn">Save to My Library</button>
            <button class="btn" id="pdfBtn">Download PDF</button>
            <button class="btn" id="copyBtn">Copy</button>
            <button class="btn" id="clearBtn">Clear</button>
          </div>
        </section>

      </section>
    </div>
  </main>

  <script>
    const API_BASE = "https://sci-guru-backend.onrender.com";

    const STORAGE_PROGRESS = "sciguru_progress_v2_book1";
    const STORAGE_SAVED = "sciguru_saved_v1";
    const STORAGE_LAST = "sciguru_last_v2_book1";

    const CHAPTERS = [
      { id: 1, term:"Biology Term 1", name: "Laboratory safety and apparatus", topics: ["Laboratory rules","Laboratory apparatus","Topic assessment"] },
      { id: 2, term:"Biology Term 1", name: "Cells and levels of organisation", topics: ["Cells","Topic assessment"] },
      { id: 3, term:"Biology Term 1", name: "Nutrition", topics: ["Nutrition and diet","Topic assessment"] },
      { id: 4, term:"Biology Term 1", name: "The respiratory system", topics: ["Air and respiratory gases","Topic assessment"] },
      { id: 5, term:"Biology Term 1", name: "Transport systems", topics: ["Transport mechanisms","Transport in plants","Transport in humans","Topic assessment"] },
      { id: 6, term:"Biology Term 1", name: "Reproductive systems", topics: ["Reproduction in plants and animals","Pollination and fertilisation","Reproduction in humans","Topic assessment"] },
      { id: 7, term:"Biology Term 1", name: "Health and diseases", topics: ["Health, hygiene and disease","Methods of disease transmission","Topic assessment"] },

      { id: 8, term:"Chemistry Term 2", name: "Separation", topics: ["Mixtures","Separation methods","Topic assessment"] },
      { id: 9, term:"Chemistry Term 2", name: "Matter", topics: ["Matter","Solubility and dissolving","Mixtures, elements and compounds","The periodic table","Topic assessment"] },
      { id:10, term:"Chemistry Term 2", name: "Acids, bases and salts", topics: ["Acids and bases","Topic assessment"] },
      { id:11, term:"Chemistry Term 2", name: "Industrial processes", topics: ["Processing peanuts","Topic assessment"] },
      { id:12, term:"Chemistry Term 2", name: "Oxidation", topics: ["Rusting","Topic assessment"] },
      { id:13, term:"Chemistry Term 2", name: "Organic chemistry", topics: ["Fuels","Topic assessment"] },

      { id:14, term:"Physics Term 3", name: "Data presentation", topics: ["Ways to present data","Topic assessment"] },
      { id:15, term:"Physics Term 3", name: "Measurements", topics: ["Measurement of physical quantities","Topic assessment"] },
      { id:16, term:"Physics Term 3", name: "Force", topics: ["Effects, types and measurement of forces","Topic assessment"] },
      { id:17, term:"Physics Term 3", name: "Energy", topics: ["Effects and forms of energy","Energy conversions","Topic assessment"] },
      { id:18, term:"Physics Term 3", name: "Magnetism", topics: ["Magnetism and magnets","Topic assessment"] },
      { id:19, term:"Physics Term 3", name: "Electricity", topics: ["Types of charge","Static and current electricity","Topic assessment"] }
    ];

    // Decide which simulation to open
    function getExperimentLink(topicName, subtopic){
      if(topicName === "Laboratory safety and apparatus"){
        const s = (subtopic || "").toLowerCase();

        // ✅ You requested: subtopic "Laboratory apparatus" opens the Bunsen simulator
        if(s.includes("apparatus")) return "sim-bunsen.html";

        // rules -> hazard simulator
        if(s.includes("rules")) return "sim-safety.html";

        // fallback
        return "virtual-lab-hub.html";
      }

      // Existing sims (adjust to your filenames if needed)
      if(topicName === "Separation") return "sim-mixtures.html";
      if(topicName === "Matter") return "sim-mixtures.html";
      if(topicName === "Electricity") return "sim-electricity.html";
      if(topicName === "Magnetism") return "sim-electricity.html";

      return "virtual-lab-hub.html";
    }

    // DOM
    const chapterListEl = document.getElementById("chapterList");
    const chapterEl = document.getElementById("chapter");
    const formEl = document.getElementById("form");
    const topicEl = document.getElementById("topic");
    const qEl = document.getElementById("q");
    const outEl = document.getElementById("out");
    const apiStatusEl = document.getElementById("apiStatus");
    const openLabBtn = document.getElementById("openLabBtn");
    const contentPills = document.getElementById("contentPills");
    const toggleDoneBtn = document.getElementById("toggleDoneBtn");
    const progressText = document.getElementById("progressText");
    const barFill = document.getElementById("barFill");
    const modeHint = document.getElementById("modeHint");
    const genBtn = document.getElementById("genBtn");

    let selectedChapter = CHAPTERS[0];
    let selectedMode = "Notes";
    let lastOutputText = "";
    let progress = loadProgress();

    function loadProgress(){
      try{
        const raw = localStorage.getItem(STORAGE_PROGRESS);
        const obj = raw ? JSON.parse(raw) : null;
        return obj && Array.isArray(obj.doneIds) ? obj : { doneIds: [] };
      }catch{ return { doneIds: [] }; }
    }
    function saveProgress(){ localStorage.setItem(STORAGE_PROGRESS, JSON.stringify(progress)); }
    function isDone(id){ return progress.doneIds.includes(id); }

    function updateProgressUI(){
      const done = progress.doneIds.length;
      const total = CHAPTERS.length;
      progressText.textContent = `Progress: ${done}/${total} topics done`;
      barFill.style.width = (total ? Math.round((done/total)*100) : 0) + "%";
      toggleDoneBtn.textContent = isDone(selectedChapter.id) ? "Mark topic as NOT done" : "Mark topic as done";
    }

    function renderOutput(text){
      lastOutputText = text || "";
      outEl.innerHTML = `<div style="white-space:pre-wrap; line-height:1.65">${text}</div>`;
    }

    function updateModeUI(){
      if(selectedMode === "Worked Examples"){
        genBtn.textContent = "Open Virtual Experiment";
        modeHint.innerHTML = `Virtual Experiments mode: Clicking <b>Open Virtual Experiment</b> launches a simulation for this topic/subtopic.`;
      }else{
        genBtn.textContent = "Generate";
        modeHint.innerHTML = `Tip: Choose <b>Virtual Experiments</b> to run a simulation instead of text worked examples.`;
      }

      // Keep “Open related lab” always correct
      openLabBtn.href = getExperimentLink(selectedChapter.name, topicEl.value);
    }

    function setMode(mode){
      selectedMode = mode;
      [...contentPills.querySelectorAll(".pill")].forEach(p=>{
        p.classList.toggle("active", p.dataset.mode === mode);
      });
      updateModeUI();
      saveLastState();
    }

    function setChapter(ch){
      selectedChapter = ch;
      chapterEl.value = `Topic ${ch.id}: ${ch.name} (${ch.term})`;
      topicEl.innerHTML = ch.topics.map(t => `<option value="${t}">${t}</option>`).join("");
      updateModeUI();

      [...chapterListEl.querySelectorAll(".chapterBtn")].forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.id == ch.id);
      });

      updateProgressUI();
      saveLastState();
    }

    function buildChapterButtons(){
      chapterListEl.innerHTML = "";
      CHAPTERS.forEach(ch=>{
        const btn = document.createElement("button");
        btn.className = "chapterBtn";
        btn.dataset.id = ch.id;

        const doneMark = isDone(ch.id) ? "✅" : "⬜";
        btn.innerHTML = `
          <div>
            Topic ${ch.id}: ${ch.name}
            <small><span class="termTag">${ch.term}</span><br>${ch.topics.length} subtopics</small>
          </div>
          <div class="check">${doneMark}</div>
        `;
        btn.onclick = ()=> setChapter(ch);
        chapterListEl.appendChild(btn);
      });
    }

    function refreshChecks(){
      [...chapterListEl.querySelectorAll(".chapterBtn")].forEach(btn=>{
        const id = Number(btn.dataset.id);
        const mark = btn.querySelector(".check");
        if(mark) mark.textContent = isDone(id) ? "✅" : "⬜";
      });
    }

    async function checkHealth(){
      try{
        const r = await fetch(`${API_BASE}/health`, { method:"GET" });
        apiStatusEl.textContent = r.ok ? "API: online" : "API: offline / sleeping";
      }catch{
        apiStatusEl.textContent = "API: offline / sleeping";
      }
    }

    async function callTutor(modeOverride){
      const mode = modeOverride || selectedMode;

      const payload = {
        mode,
        form: formEl.value,
        chapter: `Topic ${selectedChapter.id}: ${selectedChapter.name} (${selectedChapter.term})`,
        topic: topicEl.value || selectedChapter.name,
        question: qEl.value.trim() || "(no extra instruction)"
      };

      renderOutput("Loading... (Render may sleep on free tier)");
      try{
        const r = await fetch(`${API_BASE}/api/tutor`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(data?.detail || data?.error || `Request failed (${r.status})`);

        renderOutput(data.text || "No text returned.");
        saveLastState();
      }catch(e){
        renderOutput("Error: " + e.message);
      }
    }

    function loadLibrary(){
      try{
        const raw = localStorage.getItem(STORAGE_SAVED);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }

    function saveToLibrary(){
      const text = (outEl.innerText || "").trim();
      if(!text || text.toLowerCase().startsWith("loading") || text.toLowerCase().startsWith("error")){
        alert("Generate content first, then save.");
        return;
      }
      const item = {
        id: "sg_" + Date.now(),
        savedAt: new Date().toISOString(),
        mode: selectedMode,
        form: formEl.value,
        chapter: `Topic ${selectedChapter.id}: ${selectedChapter.name} (${selectedChapter.term})`,
        topic: topicEl.value || selectedChapter.name,
        instruction: qEl.value.trim(),
        content: text
      };
      const arr = loadLibrary();
      arr.unshift(item);
      localStorage.setItem(STORAGE_SAVED, JSON.stringify(arr));
      alert("Saved to My Library ✅");
    }

    function downloadPDF(){
      const text = (outEl.innerText || "").trim();
      if(!text || text.toLowerCase().startsWith("loading") || text.toLowerCase().startsWith("error")){
        alert("Generate content first, then download PDF.");
        return;
      }
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){ alert("PDF library failed to load. Refresh page and try again."); return; }

      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const margin = 40, maxWidth = 515;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text(`Sci-Guru - ${selectedMode}`, margin, 55);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Form: ${formEl.value}`, margin, 75);
      doc.text(`Topic: ${selectedChapter.id} - ${selectedChapter.name} (${selectedChapter.term})`, margin, 90);
      doc.text(`Subtopic: ${topicEl.value || selectedChapter.name}`, margin, 105);

      const lines = doc.splitTextToSize(text, maxWidth);
      let y = 135;
      doc.setFontSize(11);
      for(const line of lines){
        if(y > 800){ doc.addPage(); y = 50; }
        doc.text(line, margin, y);
        y += 14;
      }
      const safeName = `${selectedMode}_Topic${selectedChapter.id}_${(topicEl.value||"Subtopic").replace(/[^a-z0-9]+/gi,"_")}.pdf`;
      doc.save(safeName);
    }

    function saveLastState(){
      const state = {
        mode: selectedMode,
        form: formEl.value,
        chapterId: selectedChapter.id,
        topic: topicEl.value || "",
        instruction: qEl.value || "",
        lastOutput: lastOutputText || ""
      };
      localStorage.setItem(STORAGE_LAST, JSON.stringify(state));
    }

    function restoreLastState(){
      try{
        const raw = localStorage.getItem(STORAGE_LAST);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.form) formEl.value = s.form;
        if(s.mode) setMode(s.mode);
        const ch = CHAPTERS.find(x => x.id === Number(s.chapterId)) || CHAPTERS[0];
        buildChapterButtons();
        setChapter(ch);
        if(s.topic){
          const options = [...topicEl.querySelectorAll("option")].map(o=>o.value);
          if(options.includes(s.topic)) topicEl.value = s.topic;
        }
        if(typeof s.instruction === "string") qEl.value = s.instruction;
        if(typeof s.lastOutput === "string" && s.lastOutput.trim()) renderOutput(s.lastOutput);
      }catch{}
    }

    // Events
    contentPills.addEventListener("click", (e)=>{
      const pill = e.target.closest(".pill");
      if(!pill) return;
      setMode(pill.dataset.mode);
    });

    topicEl.addEventListener("change", ()=> updateModeUI());

    genBtn.onclick = ()=>{
      // Virtual experiments open pages
      if(selectedMode === "Worked Examples"){
        window.location.href = getExperimentLink(selectedChapter.name, topicEl.value);
        return;
      }
      callTutor(selectedMode);
    };

    document.getElementById("quizBtn").onclick = ()=> callTutor("Quiz");
    document.getElementById("pracBtn").onclick = ()=> callTutor("Practical");
    document.getElementById("saveBtn").onclick = saveToLibrary;
    document.getElementById("pdfBtn").onclick = downloadPDF;

    document.getElementById("copyBtn").onclick = async ()=>{
      const txt = (outEl.innerText || "").trim();
      if(!txt) return alert("Nothing to copy.");
      try{ await navigator.clipboard.writeText(txt); alert("Copied!"); }
      catch{ alert("Copy failed. Select and copy manually."); }
    };

    document.getElementById("clearBtn").onclick = ()=>{
      qEl.value = "";
      renderOutput("Cleared.");
      saveLastState();
    };

    toggleDoneBtn.onclick = ()=>{
      const id = selectedChapter.id;
      if(isDone(id)){ progress.doneIds = progress.doneIds.filter(x => x !== id); }
      else{ progress.doneIds.push(id); }
      saveProgress();
      updateProgressUI();
      refreshChecks();
    };

    // Init
    buildChapterButtons();
    setChapter(CHAPTERS[0]);
    setMode("Notes");
    checkHealth();
    restoreLastState();
    updateProgressUI();
    refreshChecks();
  </script>
</body>
</html>
