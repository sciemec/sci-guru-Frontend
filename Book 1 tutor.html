<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sci-Guru AI Science Tutor</title>

  <!-- If you already have styles.css, keep this line -->
  <link rel="stylesheet" href="styles.css"/>

  <style>
    :root{
      --bg:#070b16;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(255,255,255,.03);
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#2f6bff;
      --good:#38d678;
      --bad:#ff6262;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(47,107,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 85% 25%, rgba(56,214,120,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.20));
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .container{ width:95%; max-width:1200px; margin:0 auto; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:14px; }
    .brand{ display:flex; align-items:center; gap:12px; padding:12px 0; }
    .brand img{ width:44px; height:44px; object-fit:contain; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid var(--border); padding:6px; }
    .title b{ display:block; font-size:1.02rem; }
    .title span{ display:block; color:var(--muted); font-size:.9rem; margin-top:2px; }

    .nav{ display:flex; gap:10px; flex-wrap:wrap; }
    .nav a{
      text-decoration:none;
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      font-weight:800;
    }
    .nav a:hover{ border-color:var(--border); background:rgba(255,255,255,.03); color:var(--text); }
    .nav a.active{
      color:var(--text);
      border-color:rgba(47,107,255,.55);
      background:rgba(47,107,255,.10);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12);
    }

    /* Layout */
    main{ padding:18px 0 34px; }
    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; }
    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 6px; font-size:1.25rem; }
    .small{ color:var(--muted); font-size:.93rem; line-height:1.45; }
    label{ display:block; margin:10px 0 6px; color:var(--muted); font-weight:800; }
    select, textarea, input{
      width:100%;
      color:var(--text);
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:1rem;
      outline:none;
    }
    textarea{ min-height:120px; resize:vertical; }
    select:focus, textarea:focus, input:focus{
      border-color:rgba(47,107,255,.65);
      box-shadow:0 0 0 4px rgba(47,107,255,.14);
    }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }
    .btn.primary{
      border-color:rgba(47,107,255,.55);
      background:rgba(47,107,255,.12);
      box-shadow:0 0 0 4px rgba(47,107,255,.12);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .pillrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;
      color:var(--muted);
    }
    .pill.good{ border-color:rgba(56,214,120,.55); color:rgba(56,214,120,.95); }
    .pill.bad{ border-color:rgba(255,98,98,.55); color:rgba(255,98,98,.95); }

    /* Output area */
    .outbox{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel2);
      padding:12px;
      margin-top:10px;
      min-height:380px;
      overflow:auto;
    }
    .outmeta{
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:12px;
      margin-top:10px;
      white-space:pre-wrap;
    }
    .md h1,.md h2,.md h3{ margin:12px 0 8px; }
    .md hr{ border:none; border-top:1px solid var(--border); margin:12px 0; }
    .md ul{ margin:8px 0 8px 18px; }
    .md li{ margin:6px 0; }
    .md p{ margin:8px 0; line-height:1.55; }
    .md strong{ color:var(--text); }

    @media (max-width:980px){
      .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="container row">
    <div class="brand">
      <!-- Change logo path if yours is different -->
      <img src="images/lec-logo.png" alt="LEC Biotec Logo"/>
      <div class="title">
        <b>Sci-Guru AI Science Tutor</b>
        <span>ZIMSEC / Heritage-Based curriculum</span>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a class="active" href="tutor.html">AI Tutor</a>
      <a href="virtual-lab-hub.html">Virtual Lab Hub</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid">

    <!-- LEFT: ASK -->
    <section class="card">
      <h2>Ask Sci-Guru</h2>
      <div class="small">Choose Form and Topic, then ask a question.</div>

      <div class="pillrow">
        <span class="pill" id="apiPill">API: checking…</span>
        <span class="pill">Render Free may sleep</span>
      </div>

      <label for="formSelect">Form / Level</label>
      <select id="formSelect"></select>

      <label for="topicSelect">Topic</label>
      <select id="topicSelect"></select>

      <label for="chapterSelect">Chapter / Subtopic (optional)</label>
      <select id="chapterSelect"></select>

      <label for="question">Your question</label>
      <textarea id="question" placeholder="e.g. Explain levels of organisation using Zimbabwean examples…"></textarea>

      <div class="btnrow">
        <button class="btn primary" id="askBtn">Ask Sci-Guru</button>
        <button class="btn" id="quizBtn">Generate quiz</button>
        <button class="btn" id="pracBtn">Generate practical</button>
      </div>

      <div class="btnrow">
        <button class="btn" id="openExpBtn">Open experiment</button>
        <a class="btn" href="virtual-lab-hub.html" style="text-decoration:none; display:inline-block;">Open virtual lab hub</a>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: If you don’t select a chapter, Sci-Guru answers generally for the chosen Topic.
      </div>
    </section>

    <!-- RIGHT: OUTPUT -->
    <section class="card">
      <h2>Output</h2>
      <div class="small">Your explanation / quiz / practical will appear here.</div>

      <div class="outmeta" id="meta">
Mode: Explain
Form: -
Topic: -
Chapter: -
      </div>

      <div class="outbox md" id="output">
        <p class="small">Ask a question to start.</p>
      </div>
    </section>

  </div>
</main>

<script>
  /********************
   * CONFIG
   ********************/
  const API_BASE = "https://sci-guru-backend.onrender.com";  // ✅ your Render backend
  const API_TUTOR = "/api/tutor";
  const API_HEALTH = "/health"; // (optional) if you add it in backend. If not, we still handle it.

  /********************
   * FORM + TOPICS DATA
   * (Keep it simple and safe — no copyrighted book text)
   ********************/
  const DATA = {
    "Form 1": {
      "Topic 1: Measurement & Safety": [
        "Measurement (length, mass, time, temperature)",
        "SI units & instruments",
        "Safety symbols & lab rules",
        "Topic assessment"
      ],
      "Topic 2: Cells and levels of organisation": [
        "Cells (basic structures)",
        "Levels of organisation",
        "Microscope skills",
        "Osmosis & diffusion",
        "Topic assessment"
      ],
      "Topic 3: States of Matter": [
        "Particles model",
        "Changes of state",
        "Heating & cooling curves",
        "Topic assessment"
      ],
      "Topic 4: Electricity (Basics)": [
        "Electricity basics",
        "Simple circuits",
        "Conductors & insulators",
        "Topic assessment"
      ]
    },
    "Form 2": {
      "Topic 1: Energy": ["Forms of energy", "Energy transfer", "Topic assessment"],
      "Topic 2: Forces": ["Types of forces", "Friction", "Pressure", "Topic assessment"]
    },
    "Form 3": {
      "Topic 1: Chemistry Foundations": ["Atoms & elements", "Compounds & mixtures", "Topic assessment"]
    },
    "Form 4": {
      "Topic 1: Revision & Exam Practice": ["Past questions practice", "Topic assessment"]
    }
  };

  /********************
   * DOM
   ********************/
  const formSelect = document.getElementById("formSelect");
  const topicSelect = document.getElementById("topicSelect");
  const chapterSelect = document.getElementById("chapterSelect");
  const questionEl = document.getElementById("question");

  const askBtn = document.getElementById("askBtn");
  const quizBtn = document.getElementById("quizBtn");
  const pracBtn = document.getElementById("pracBtn");
  const openExpBtn = document.getElementById("openExpBtn");

  const apiPill = document.getElementById("apiPill");
  const meta = document.getElementById("meta");
  const output = document.getElementById("output");

  /********************
   * HELPERS
   ********************/
  function escapeHtml(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // very small markdown renderer (headings, bold, hr, bullet lists)
  function renderMarkdown(md){
    const safe = escapeHtml(md);

    // headings
    let html = safe
      .replace(/^### (.*)$/gm, "<h3>$1</h3>")
      .replace(/^## (.*)$/gm, "<h2>$1</h2>")
      .replace(/^# (.*)$/gm, "<h1>$1</h1>");

    // hr
    html = html.replace(/^\-\-\-$/gm, "<hr>");

    // bold **text**
    html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

    // bullet list
    // convert lines starting with "- " into <li>
    const lines = html.split("\n");
    let out = [];
    let inList = false;
    for(const line of lines){
      if(line.trim().startsWith("- ")){
        if(!inList){ out.push("<ul>"); inList = true; }
        out.push("<li>" + line.trim().slice(2) + "</li>");
      } else {
        if(inList){ out.push("</ul>"); inList = false; }
        if(line.trim() === "") out.push("");
        else out.push("<p>" + line + "</p>");
      }
    }
    if(inList) out.push("</ul>");
    return out.join("\n");
  }

  function setMeta(mode, form, topic, chapter){
    meta.textContent =
`Mode: ${mode}
Form: ${form || "-"}
Topic: ${topic || "-"}
Chapter: ${chapter || "-"}`;
  }

  function setOutput(text){
    output.innerHTML = renderMarkdown(text || "No response.");
    output.scrollTop = 0;
  }

  function setApiStatus(ok){
    apiPill.textContent = ok ? "API: online" : "API: offline";
    apiPill.classList.remove("good","bad");
    apiPill.classList.add(ok ? "good" : "bad");
  }

  function populateForms(){
    formSelect.innerHTML = "";
    Object.keys(DATA).forEach(f=>{
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      formSelect.appendChild(opt);
    });
  }

  function populateTopics(){
    const form = formSelect.value;
    topicSelect.innerHTML = "";
    const topics = Object.keys(DATA[form] || {});
    topics.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      topicSelect.appendChild(opt);
    });
  }

  function populateChapters(){
    const form = formSelect.value;
    const topic = topicSelect.value;
    chapterSelect.innerHTML = "";

    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "— Optional: choose a chapter —";
    chapterSelect.appendChild(empty);

    const chapters = (DATA[form] && DATA[form][topic]) ? DATA[form][topic] : [];
    chapters.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      chapterSelect.appendChild(opt);
    });
  }

  function normalize(s){ return (s || "").toLowerCase(); }

  // Map to simulation pages
  function getExperimentLink(form, topicName, chapterName){
    const t = normalize(topicName);
    const c = normalize(chapterName);

    // Topic 2: Cells and levels of organisation
    if(t.includes("cells and levels")){
      if(c.includes("levels")) return "sim-levels.html";
      return "sim-cells-hub.html";
    }

    // Topic 1: Measurement & Safety
    if(t.includes("measurement")){
      return "sim-measurement-hub.html"; // you can create later, or change to a real page
    }

    // Electricity (Basics)
    if(t.includes("electricity")){
      return "sim-electricity.html"; // your existing electricity simulation
    }

    // Default fallback
    return "virtual-lab-hub.html";
  }

  async function pingApi(){
    // Some backends don't have /health; we attempt it but handle failure safely
    try{
      const r = await fetch(API_BASE + API_HEALTH, { method:"GET" });
      setApiStatus(r.ok);
    }catch(e){
      // If /health doesn't exist, we still might be online. We'll mark offline for now.
      setApiStatus(false);
    }
  }

  async function callTutor(mode){
    const form = formSelect.value;
    const topic = topicSelect.value;
    const chapter = chapterSelect.value;
    const question = (questionEl.value || "").trim();

    setMeta(mode, form, topic, chapter);

    if(!question){
      setOutput("Please type a question first.");
      return;
    }

    askBtn.disabled = quizBtn.disabled = pracBtn.disabled = true;
    setOutput("Working… (If Render was sleeping, first request may take longer.)");

    try{
      const res = await fetch(API_BASE + API_TUTOR, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          mode,
          form,
          topic,
          chapter,      // ✅ included (optional)
          question
        })
      });

      if(!res.ok){
        const msg = await res.text().catch(()=> "");
        setApiStatus(false);
        setOutput(`Server error (${res.status}).\n\n${msg || "No details returned."}`);
        return;
      }

      const data = await res.json();
      setApiStatus(true);

      const text = data?.text || data?.answer || data?.output || "";
      if(!text){
        setOutput("No text returned from API. Check backend response shape.");
      }else{
        setOutput(text);
      }
    }catch(err){
      setApiStatus(false);
      setOutput("Could not reach the API.\n\nCheck:\n- Render URL correct\n- Backend is running\n- CORS allowed for GitHub Pages");
    }finally{
      askBtn.disabled = quizBtn.disabled = pracBtn.disabled = false;
    }
  }

  /********************
   * EVENTS
   ********************/
  formSelect.addEventListener("change", ()=>{
    populateTopics();
    populateChapters();
    setMeta("Explain", formSelect.value, topicSelect.value, chapterSelect.value);
  });

  topicSelect.addEventListener("change", ()=>{
    populateChapters();
    setMeta("Explain", formSelect.value, topicSelect.value, chapterSelect.value);
  });

  chapterSelect.addEventListener("change", ()=>{
    setMeta("Explain", formSelect.value, topicSelect.value, chapterSelect.value);
  });

  askBtn.addEventListener("click", ()=> callTutor("Explain"));
  quizBtn.addEventListener("click", ()=> callTutor("Quiz"));
  pracBtn.addEventListener("click", ()=> callTutor("Practical"));

  openExpBtn.addEventListener("click", ()=>{
    const link = getExperimentLink(formSelect.value, topicSelect.value, chapterSelect.value);
    window.location.href = link;
  });

  // Enter key shortcut (Ctrl+Enter)
  questionEl.addEventListener("keydown", (e)=>{
    if(e.ctrlKey && e.key === "Enter"){
      callTutor("Explain");
    }
  });

  /********************
   * INIT
   ********************/
  populateForms();
  populateTopics();
  populateChapters();
  setMeta("Explain", formSelect.value, topicSelect.value, chapterSelect.value);
  pingApi();
</script>
</body>
</html>
